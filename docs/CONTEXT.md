## CMS-страницы (Page)

- Назначение: простые контентные страницы приложения, управляемые из админского API.
- Модель Prisma: `Page { id, slug @unique, title, type enum, content, status PublicationStatus, language, seoId?, createdAt, updatedAt }`.
- Статусы: draft/published — публичный эндпоинт возвращает только published.
- Язык: одна запись на язык (строгий enum из Prisma на текущий момент).
- SEO: опциональная 1:1-связь с `Seo` (именованная relation `SeoForPage`).
- Эндпоинты:
  - Публичные: `GET /pages/:slug`.
  - Админ: `GET /admin/pages`, `POST /admin/pages`, `PATCH /admin/pages/:id`, `PATCH /admin/pages/:id/publish`, `PATCH /admin/pages/:id/unpublish`, `DELETE /admin/pages/:id`.
- Валидация: slug по `SLUG_PATTERN`, перечисления для `type`/`language`.
- Тесты: e2e `pages.e2e-spec.ts` покрывает основные сценарии.

## Языки и политика выбора

- Поддерживаемые коды языков заданы через Prisma enum `Language` (en, es, fr, pt). Добавление нового языка — через миграцию Prisma.
- Резолвинг языка в публичных ручках: `?lang` → заголовок `Accept-Language` → `DEFAULT_LANGUAGE` (env, по умолчанию `en`).
- Реализация в `src/shared/language/language.util.ts`; задокументировано в README.
- Специфика `GET /books/:bookId/versions`: при отсутствии явного `?language=` применяется `Accept-Language` (c фолбэком к `DEFAULT_LANGUAGE`), иначе используется язык из параметра. Это поведение покрыто e2e `test/book-versions-list-language.e2e-spec.ts`.

# Package manager

- Проект работает на yarn. Агентам и разработчикам: используйте только команды yarn, не используйте npm.
- Примеры:
  - `yarn`
  - `yarn prisma:generate`
  - `yarn start:dev`

# Заметка: prisma/node_modules внутри каталога prisma

- Рабочая схема — только `prisma/schema.prisma`.
- Если внутри папки `prisma/` появился собственный `node_modules/` и, как следствие, `prisma/node_modules/@prisma/client/schema.prisma`, это приводит к конфликтам (дубли источников/генераторов/моделей) в IDE.
- Решение: удалить `prisma/node_modules` и работать с npm/yarn только из корня проекта. Затем выполнить `yarn prisma:generate` для регенерации клиента.

# AGENT_CONTEXT

Этот документ помогает ИИ-агенту быстро понять контекст проекта и наши правила работы.

## Цели документа

- Зафиксировать договорённости по стилю, миграциям, тестам и документации.
- Упростить продолжение итераций без потери контекста.

## Общие правила

- Следуем модульной архитектуре NestJS. Каждый публичный эндпоинт должен иметь DTO и Swagger-описание.
- Валидации строго через class-validator/class-transformer. Не возвращаем внутренние поля БД напрямую.
- Для любых изменений в Prisma — сначала правим `prisma/schema.prisma`, затем создаём и применяем миграцию, затем генерируем клиент.
- Миграции должны быть атомарны и обратимы; избегаем destructive изменений без явной необходимости.

## Тестирование

- Есть два уровня тестов: unit и e2e. Избегаем неустойчивых тестов.
- При изменениях публичного поведения обязательно дополняем e2e.
- Все тесты должны проходить локально перед завершением итерации.

## Документация

- Любая новая функциональность должна быть отражена:
  - в `docs/ITERATION_TASKS.md` — чекбоксы, заметки, миграции, e2e.
  - в `README.md` — разделы с краткими инструкциями и ссылками на Swagger/DTO.
  - при необходимости — в `docs/PROJECT_OVERVIEW.md` (высокоуровневое описание).
- Добавляйте раздел "Изменения" в `CHANGELOG.md` с датой и ключевыми пунктами.

## Миграции/Prisma

- Пример последовательности: правим модель → создаём миграцию → применяем → `yarn prisma:generate` → обновляем сиды при необходимости.
- Конфликты миграций решаем аккуратно: если индекс уже существует, фиксируем состояние и создаём новую миграцию без дублирования.

## Конвенции кода

- Имена DTO заканчиваются на `Dto`, схемы Swagger по возможности реиспользуемые.
- Отдаём массивы в контроллерах как есть; для деревьев используем плоский запрос + сборка в памяти, если объём мал.
- На удаление с зависимостями — явные проверки в сервисах; soft-delete где это оправдано.

## Пример — категории (иерархия)

- `Category.parentId` — self FK, индекс по `parentId`.
- Эндпоинты дерева/детей используют общий `CategoryTreeNodeDto`.
- Запрещаем циклы/самопривязку; удаление родителя с детьми — 400.

## Дальнейшие итерации

- Следуем порядку из раздела "Очередь выполнения" в `docs/ITERATION_TASKS.md`.
- Перед началом новой итерации перечитайте последнюю запись в `CHANGELOG.md` и примечания к соответствующей задаче.
