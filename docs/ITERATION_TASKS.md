# Итерационный план (реализуем по шагам)

Ниже — упорядоченный список задач, каждая с кратким ТЗ для однозначного исполнения в отдельной итерации. Список расширяемый: добавляйте новые пункты и подзадачи по мере выявления потребностей.

Принципы формата ТЗ:

- Цель — что меняется и зачем.
- Объём — ключевые изменения/файлы.
- Критерии приёмки — как проверяем готовность.
- Замечания — границы/не-цели.

---

## Очередь выполнения (мастер-порядок)

В этом списке задачи перечислены в том порядке, в котором их стоит выполнять сейчас (без пересборки разделов ниже):

1. 18 — Черновики/публикация для книг и версий — [x] (2025-08-25)
2. 19 — Обзор книги и доступность разделов (флаги/URL)
3. 20 — Категории: Подкатегории (иерархия)
4. 21 — Теги: модель и привязка к версиям
5. 22 — CMS-страницы приложения (Page)
6. 23 — Медиа-библиотека (повторное использование)
7. 24 — Языки: политика выбора и расширяемость набора
8. 25 — SEO bundle сервис (OG/Twitter/Canonical)

Далее — инфраструктурные и платформенные задачи (их можно выполнять параллельно, но ниже основной приоритет):

9. 1 — Dev-воркфлоу: Husky + lint-staged + pre-commit
10. 2 — VS Code задачи (.vscode/tasks.json)
11. 3 — README актуализация
12. 4 — docs/AGENT_CONTEXT.md
13. 5 — Docker Compose (dev): Postgres + Redis
14. 6 — .env.example расширение
15. 7 — Юнит-тесты (первый пакет)
16. 8 — Безопасность: Helmet, CORS, лимиты тела
17. 9 — Health/Readiness (terminus)
18. 10 — Prometheus метрики
19. 11 — GitHub Actions (CI)
20. 12 — Dockerfile(prod) + docker-compose.prod.yml
21. 14 — SEO: sitemap.xml и robots.txt
22. 15 — BullMQ (интеграция базовая)
23. 16 — Sentry (ошибки)
24. 17 — Uploads (R2, Cloudflare) — отложено

## 1) Dev-воркфлоу: Husky + lint-staged + pre-commit

- Цель: Блокировать коммиты с линт/формат/тип-ошибками; ускорить локальную проверку качества.
- Объём:
  - Добавить devDeps: husky, lint-staged.
  - Инициализировать Husky; создать `.husky/pre-commit`.
  - В `package.json` добавить `lint-staged` конфиг: eslint --fix, prettier --write для ts/yml/md; быстрый `tsc --noEmit`.
- Критерии приёмки: при попытке `git commit` с ошибками линтера/типов — коммит блокируется; без ошибок — проходит.
- Замечания: unit-тесты в pre-commit не запускаем (будут отдельной задачей).

## 2) VS Code задачи (.vscode/tasks.json)

- Цель: Быстрые команды из VS Code: lint, typecheck, test:e2e, dev, prisma-сценарии.
- Объём: Создать `.vscode/tasks.json` с задачами: `lint`, `typecheck`, `test:e2e`, `dev`, `prisma:migrate`, `prisma:seed`, `prisma:studio`.
- Критерии приёмки: задачи видны и запускаются в VS Code; ошибки подсвечиваются в Problems.
- Замечания: использовать текущие скрипты `yarn` из `package.json`.

## 3) README актуализация

- Цель: Документация запуска и разработки.
- Объём: Переписать `README.md` разделы: требования (Node/Yarn/Docker), `.env` переменные, миграции/сиды, запуск, Swagger, статические файлы `/static`, тесты (unit/e2e), оговорки про локальные загрузки.
- Критерии приёмки: новый разработчик поднимает проект по README без внешней помощи.
- Замечания: ссылку на Swagger и на этот план добавить.

## 4) docs/AGENT_CONTEXT.md

- Цель: Правила для ИИ-агента (стиль, формат PR, границы изменений, как работать с миграциями/тестами).
- Объём: Создать `docs/AGENT_CONTEXT.md` с практиками и соглашениями по коду.
- Критерии приёмки: документ существует, покрывает основное; ссылка добавлена в README.
- Замечания: лаконично, по делу.

## 5) Docker Compose (dev): Postgres + Redis

- Цель: Единая локальная среда без ручной установки сервисов.
- Объём: Добавить `docker-compose.yml` (postgres, redis, волюмы, healthcheck), `DATABASE_URL` в `.env.example` для compose, makefile-алиасы (опц.).
- Критерии приёмки: `docker compose up -d` поднимает БД/Redis; приложение подключается; `yarn prisma:migrate` успешно применяет миграции.
- Замечания: данные в именованных volume, экспонировать 5432/6379 только локально.

## 6) .env.example расширение

- Цель: Все переменные, которые использует код, должны быть отражены в примере.
- Объём: Добавить/обновить: RATE_LIMIT_ENABLED, RATE_LIMIT_COMMENTS_WINDOW_MS, RATE_LIMIT_COMMENTS_PER_MINUTE, LOCAL_UPLOADS_DIR, LOCAL_PUBLIC_BASE_URL, UPLOADS_MAX_IMAGE_MB, UPLOADS_MAX_AUDIO_MB, UPLOADS_PRESIGN_TTL_SEC, UPLOADS_ALLOWED_IMAGE_CT, UPLOADS_ALLOWED_AUDIO_CT, CONTENT_MANAGER_EMAILS, CORS_ORIGIN, PORT.
- Критерии приёмки: при копировании `.env.example` → `.env` приложение стартует; значения по умолчанию соответствуют коду.
- Замечания: поясняющие комментарии к каждому ключу.

## 7) Юнит-тесты (первый пакет)

- Цель: Базовое покрытие ключевых сервисов без БД.
- Объём: Добавить `*.spec.ts` для 2–3 сервисов (например: BookVersionService, LikesService, CommentsService) с моками Prisma/кэша. Настроить jest для unit (rootDir/paths уже есть).
- Критерии приёмки: `yarn test` проходит; минимум по 2–3 теста на сервис (happy + 1 edge).
- Замечания: e2e не трогаем.

## 8) Безопасность: Helmet, CORS, лимиты тела

- Цель: Базовая защита HTTP, корректный CORS, предсказуемые лимиты тела.
- Объём: В `main.ts` подключить Helmet; CORS по `CORS_ORIGIN`; общий `json/raw` body limit из env (кроме `/uploads/direct`, где уже задано).
- Критерии приёмки: приложение стартует; preflight проходит; e2e зелёные.
- Замечания: не включать строгие политики, лояльные дефолты для dev.

## 9) Health/Readiness (terminus)

- Цель: Эндпоинты `/health/liveness`, `/health/readiness` (DB+Redis).
- Объём: Подключить `@nestjs/terminus`; создать модуль/контроллер; проверки Prisma и Redis (если Redis недоступен — readiness=false, liveness=true).
- Критерии приёмки: корректные коды/JSON для обоих эндпоинтов.
- Замечания: Redis клиент реиспользовать/провайдить; для dev можно заглушку, если Redis не сконфигурирован.

## 10) Prometheus метрики

- Цель: `/metrics` с базовыми метриками процесса и HTTP.
- Объём: `prom-client`, коллекция default metrics; middleware/interceptor для HTTP duration/код ответа; endpoint `/metrics`.
- Критерии приёмки: curl `/metrics` возвращает текстовую экспозицию; значения растут/изменяются при запросах.
- Замечания: без аутентификации на dev.

## 11) GitHub Actions (CI)

- Цель: Автоматическая проверка PR.
- Объём: workflow матрица: lint, typecheck, unit, e2e (services: postgres, redis), build, prisma validate; кеш npm/yarn; артефакт coverage.
- Критерии приёмки: pipeline проходит в репозитории; статусы видны.
- Замечания: e2e запускать в `--runInBand`.

## 12) Dockerfile(prod) + docker-compose.prod.yml

- Цель: Повторяемая сборка и запуск.
- Объём: Мультистейдж Dockerfile (build+runtime), `.dockerignore`; `docker-compose.prod.yml` (api+postgres+redis+nginx опц.). Скрипт старта: `prisma migrate deploy` перед `node dist/main`.
- Критерии приёмки: локальная сборка успешна; контейнер стартует; миграции применяются.
- Замечания: переменные окружения передавать через compose/секреты.

## 13) Политика выбора языка версии

- Цель: Единые правила выбора `BookVersion` по языку.
- Объём: Поддержать `?lang=` и заголовок `Accept-Language`; фолбэк на язык книги/дефолт из env; утилита + e2e на 2–3 сценария.
- Критерии приёмки: корректный выбор и фолбэк; документировано в README.
- Замечания: не трогаем бизнес-логику CRUD.

## 14) SEO: sitemap.xml и robots.txt

- Цель: Базовая SEO-отдача.
- Объём: Endpoint `GET /sitemap.xml` (версии книг с canonical), `GET /robots.txt` (лояльный дефолт). Кэшировать на 30–60с.
- Критерии приёмки: корректный content-type; XML/текст валидны; e2e smoke.
- Замечания: без приоритезации/lastmod — MVP.

## 15) BullMQ (интеграция базовая)

- Цель: Готовность к фоновым задачам.
- Объём: Модуль очередей, подключение к Redis, 1 пример job-та (no-op), health-ручка со статистикой.
- Критерии приёмки: очередь создаётся; health возвращает счетчики; e2e smoke.
- Замечания: бизнес-джобы вне диапазона этой итерации.

## 16) Sentry (ошибки)

- Цель: Сбор ошибок prod/staging.
- Объём: Инициализация SDK, фильтры Nest для необработанных ошибок, конфиг через env (dsn, env, release), маскирование секретов.
- Критерии приёмки: в dev можно отключить; ручной тест генерирует событие при включении.
- Замечания: performance tracing опционально.

## 17) Uploads (R2, Cloudflare) — отложено

- Цель: S3-совместимый драйвер и presigned PUT.
- Объём: Драйвер R2, presign для PUT, переменные R2\_\*, совместимость API `/uploads/presign`.
- Критерии приёмки: интеграционный smoke с MinIO или моками; документация.
- Замечания: выполнять после стабилизации локального драйвера и деплой-инфры.

---

Расширение списка

- Если в ходе ревью функциональных модулей обнаружатся пробелы, добавляйте новые пункты по этому же шаблону (Цель/Объём/Критерии/Замечания) и указывайте приоритет/порядок.

## 18) Черновики/публикация для книг и версий

- Цель: Возможность готовить контент до публикации.
- Объём:
  - [x] Prisma: добавлены поля `BookVersion.status` (draft|published), `publishedAt` и enum `PublicationStatus`; миграция применена.
  - [x] Backend: эндпоинты `PATCH /versions/:id/publish` и `PATCH /versions/:id/unpublish` (только admin|content_manager).
  - [x] Публичные методы и листинги учитывают статус (возвращают только published).
  - [x] Админский листинг: `GET /admin/books/:bookId/versions` — включает черновики; также `GET /books/:bookId/versions?includeDrafts=true` (корректно для авторизованных админов/контент-менеджеров).
  - [x] e2e: добавлен сценарий черновик/публикация/скрытие (см. `test/book-version.e2e-spec.ts`).
- Критерии приёмки: статусы корректно соблюдаются во всех списках/деталях (покрыто e2e).
- Замечания: для глав/аудио-глав — можно унаследовать от версии (или отдельные статусы вынести в отдельную последующую задачу).

Примечания по реализации:

- Новые версии создаются со статусом `draft` по умолчанию.
- Публичный GET `/versions/:id` возвращает 404 для черновиков.
- READMЕ обновлён: раздел про публикацию версий, примеры запросов.

## 19) Обзор книги и доступность разделов (флаги/URL)

- Цель: Для фронтенда возвращать агрегированные флаги наличия разделов и их URL/идентификаторы.
- Объём:
  - Эндпоинт: `GET /books/:slug/overview?lang=xx` → { book, availableLanguages[], hasText, hasAudio, hasSummary, versionIds: {text?, audio?}, seo: { for main/read/listen/summary } }.
  - Реализация на базе `Book`, `BookVersion`, `AudioChapter`, `BookSummary`, `Seo`.
- Критерии приёмки: для книги с текстом/аудио/пересказом флаги и SEO заполнены корректно; для отсутствующих — false/null; e2e на 2–3 сценария.
- Замечания: SEO берём из `Seo` версии с фолбэками; поля H1 — формируем из title/author по шаблонам (опц.).

## 20) Категории: Подкатегории (иерархия)

- Цель: Поддержать дерево категорий (родитель/дети) для группировок жанров и разделов.
- Объём:
  - Prisma: `Category.parentId` (self-relation), индексы; миграция.
  - Контроллер/сервис: создать/обновлять с `parentId`; `GET /categories/:id/children` и `GET /categories/tree` (ограниченная глубина, напр., 3 уровня).
  - Валидация: запрет циклов, `parentId != id`.
- Критерии приёмки: CRUD работает; дерево возвращается с корректной вложенностью; e2e на создание цепочки и выборку.
- Замечания: удаление родителя с детьми — запретить (или требовать предыдущий перенос/удаление детей).

## 21) Теги: модель и привязка к версиям книг

- Цель: Метить версии книг свободными тегами и фильтровать по ним.
- Объём:
  - Prisma: `Tag` (id, name, slug @unique), `BookTag` (versionId, tagId @@unique), индексы.
  - Эндпоинты: CRUD `tags`; `POST /versions/:id/tags` attach, `DELETE /versions/:id/tags/:tagId` detach; `GET /tags/:slug/books` — версии по тегу.
  - Валидация slug (regex), идемпотентный attach/detach.
- Критерии приёмки: e2e CRUD и attach/detach; выборка по тегу возвращает корректные версии.
- Замечания: теги — плоские, без иерархии.

## 22) CMS-страницы приложения (Page)

- Цель: Управлять контентными страницами приложения (общие страницы, шаблоны главных разделов).
- Объём:
  - Prisma: `Page` (id, slug @unique, title, type enum: generic|category_index|author_index, content (JSON|text), status draft|published, language, seoId?, timestamps).
  - Эндпоинты: CRUD для админов; публичные `GET /pages/:slug` (только published).
  - Swagger/валидации; базовые e2e (draft недоступен публично).
- Критерии приёмки: страница создаётся/редактируется/публикуется; публичная выдача корректна.
- Замечания: контент — простой (без блочного редактора); мультиязычие — одноязычные записи на версию языка.

## 23) Медиа-библиотека (повторное использование изображений/аудио)

- Цель: Централизованно хранить и переиспользовать медиа-объекты (как в WordPress Media Library).
- Объём:
  - Prisma: `MediaAsset` (id, key, url, contentType, size, width?, height?, hash?, createdAt, createdBy?).
  - Эндпоинты: `POST /media/confirm` (на основе уже загруженного через `/uploads` key создаёт запись в БД), `GET /media` (листинг/поиск), `DELETE /media/:id` (опц. soft-delete).
  - Интеграция: вернуть publicUrl/ключ; возможность привязки медиa к сущностям через ключ/id (пока без жёсткой FK замены).
- Критерии приёмки: один и тот же файл может использоваться в нескольких местах без дублирования; e2e smoke (создание, повторное использование, удаление).
- Замечания: рефактор `BookVersion.coverImageUrl` → `mediaId` вынести в отдельную задачу (миграция данных).

## 24) Языки: политика выбора и расширяемость набора

- Цель: Устойчиво выбирать версию по языку и уметь добавлять новые языки.
- Объём:
  - Политика выбора (см. задачу 13) + дефолт из env.
  - ADR: оставить Prisma enum и добавлять языки миграциями ИЛИ мигрировать на таблицу `Language` (динамический список).
  - Реализация выбранного подхода (если таблица — миграция, DTO→string, сиды языков).
- Критерии приёмки: после добавления нового языка (миграция/сид) API принимает и отдаёт этот язык; выбор версии работает.
- Замечания: предпочтителен enum до усложнения требований; таблица — отдельная ветка работ.

## 25) SEO bundle сервис (OG/Twitter/Canonical)

- Цель: Единая сборка SEO-мета с фолбэками и правилами.
- Объём:
  - Сервис-компоновщик SEO: при отсутствии явных полей `Seo` — использовать разумные дефолты (title из версии/книги, canonical из маршрута).
  - Эндпоинт: `GET /seo/resolve?type=book|version|page&id=...` → OG/Twitter/robots/canonical.
  - Документация шаблонов и приоритетов источников.
- Критерии приёмки: фронтенд получает полный набор полей для сниппетов; e2e smoke.
- Замечания: sitemap/robots остаются в задачах 14; здесь — сборка мета для карточек/страниц.
