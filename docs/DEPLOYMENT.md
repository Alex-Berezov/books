# Production Deployment Guide

> –¶–µ–ª—å: –ë—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—É—â–∏–π backend (NestJS + PostgreSQL + Prisma + Redis/BullMQ + Docker) –≤ –ø—Ä–æ–¥ –Ω–∞ VPS, —á—Ç–æ–±—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π API.

## –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–õ–µ–≥–µ–Ω–¥–∞:**

- ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ
- ‚è≥ –ì–æ—Ç–æ–≤–æ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é
- ‚ùå –ù–µ –Ω–∞—á–∞—Ç–æ

---

## –≠–¢–ê–ü 1: –ü–û–î–ì–û–¢–û–í–ö–ê –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´

### 1. –î–æ–º–µ–Ω—ã –∏ DNS ‚ùå

- –û—Å–Ω–æ–≤–Ω–æ–π: `api.example.com` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π API.
- (–û–ø—Ü.) `admin.example.com` ‚Äî –µ—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞.
- DNS: A/AAAA ‚Üí IP VPS. TTL 300‚Äì600 –Ω–∞ —ç—Ç–∞–ø–µ —á–∞—Å—Ç—ã—Ö –∞–ø–¥–µ–π—Ç–æ–≤.
- –ü—Ä–æ–≤–µ—Ä–∫–∞: `dig +short api.example.com`.

### 2. VPS / –°–µ—Ä–≤–µ—Ä ‚ùå

- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–∞—Ä—Ç: 2 vCPU, 2‚Äì4 GB RAM, 20+ GB SSD.
- –û–°: Ubuntu 24.04 LTS –∏–ª–∏ Debian 12.
- –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `deploy`, –¥–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É `docker`.
- –ü–æ—Ä—Ç—ã: 80/443 (proxy), 22 (SSH), –ë–î/Redis –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞—Ä—É–∂—É.
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `apt update && apt upgrade -y`.

### 3. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã ‚è≥

- –ò—Å–ø–æ–ª—å–∑—É–µ–º `Dockerfile` (multi-stage) + `docker-compose.prod.yml`.
- Redis –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ –≤–∫–ª—é—á–∞—Ç—å (–µ—Å–ª–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω BullMQ) ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –∑–∞–¥–∞–≤–∞—Ç—å `REDIS_*`.
- –¢–µ–≥–∏ –æ–±—Ä–∞–∑–æ–≤: `prod-vX.Y.Z`, `sha-<SHORT_SHA>`, `latest` (–Ω–µ –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã).
- Registry: GitLab / GHCR / —á–∞—Å—Ç–Ω—ã–π.

### 4. Git / –í–µ—Ç–∫–∏ / –†–µ–ª–∏–∑—ã ‚è≥

- `main` ‚Äî –ø—Ä–æ–¥.
- Feature –≤–µ—Ç–∫–∏ ‚Üí PR ‚Üí merge –≤ `main`.
- –¢–µ–≥ –ø—Ä–∏ —Ä–µ–ª–∏–∑–µ: `v1.0.0` (—Ç—Ä–∏–≥–≥–µ—Ä –¥–µ–ø–ª–æ—è).
- –í–æ–∑–º–æ–∂–µ–Ω trunk-based –±–µ–∑ develop.

### 5. CI/CD (–ö–æ–Ω—Ü–µ–ø—Ç) ‚è≥

Stages:

1. Install: `yarn --frozen-lockfile`.
2. Lint: `yarn lint`.
3. Typecheck: `yarn typecheck`.
4. Unit: `yarn test`.
5. E2E: `yarn test:e2e` (–≤ CI —Å–µ—Ä–≤–∏—Å Postgres + –º–∏–≥—Ä–∞—Ü–∏–∏).
6. Build image: `docker build -t registry/books-app:${CI_COMMIT_SHA} -f Dockerfile .`.
7. Tag + push: `prod-vX.Y.Z` (–µ—Å–ª–∏ —Ä–µ–ª–∏–∑).
8. Deploy: pull –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Üí `docker compose ... up -d`.

- –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç entrypoint (`prisma migrate deploy`) ‚Äî –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å.

## –≠–¢–ê–ü 2: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

### 6. ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env.prod)

```
DATABASE_URL=postgresql://app_user:STRONG_PASS@postgres:5432/books?schema=public
PORT=5000
HOST=0.0.0.0
DEFAULT_LANGUAGE=en
LOCAL_PUBLIC_BASE_URL=https://api.example.com/static
CORS_ORIGIN=https://frontend.example.com
SWAGGER_ENABLED=0
RATE_LIMIT_GLOBAL_ENABLED=1
ADMIN_EMAILS=admin@example.com
CONTENT_MANAGER_EMAILS=editor@example.com
# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ Redis / BullMQ
# REDIS_HOST=redis
# REDIS_PORT=6379
# BULLMQ_IN_PROCESS_WORKER=0
TRUST_PROXY=1
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ - `.env.prod` —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

- –§–∞–π–ª—ã: `.env.prod`, `check_prod_config.js`, `test_prod_settings.sh`
- –•—Ä–∞–Ω–µ–Ω–∏–µ: CI protected vars + –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ `chmod 600 /opt/books/app/.env.prod`.

### 7. ‚úÖ Reverse Proxy / TLS

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ - Caddy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞

- Caddy –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`configs/Caddyfile.prod`) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º HTTPS
- –°–∫—Ä–∏–ø—Ç—ã: `scripts/install_caddy.sh`, `scripts/test_reverse_proxy.sh`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `docs/REVERSE_PROXY_GUIDE.md`
- –ü—Ä–æ–∫—Å–∏: `api.example.com` ‚Üí `app:5000`.
- `/metrics` –∑–∞—â–∏—â–µ–Ω –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (403 Forbidden).
- `TRUST_PROXY=1` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `.env.prod`.

### 8. –°—Ç–∞—Ç–∏–∫–∞ –∏ Uploads ‚è≥

- –õ–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏: volume ‚Üí `/opt/books/uploads` (–∏–ª–∏ docker volume).
- BACKUP –≤–∫–ª—é—á–∞—Ç—å uploads –≤–º–µ—Å—Ç–µ —Å –ë–î.
- –ü–æ–∑–∂–µ –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ S3 (–º–µ–Ω—è–µ–º URL –≥–µ–Ω–µ—Ä–∞—Ü–∏—é + ENV).

### 9. PostgreSQL (–ü—Ä–æ–¥) ‚è≥

- –û—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –º–∏–Ω–∏–º—É–º –ø—Ä–∞–≤ (–Ω–µ superuser).
- Volume/dir: `/var/lib/postgresql/data`.
- –ê–≤—Ç–æ–±—ç–∫–∞–ø (cron): `pg_dump books | gzip > /opt/books/backups/books-$(date +%F).sql.gz`.
- –•—Ä–∞–Ω–µ–Ω–∏–µ 7‚Äì14 –¥–Ω–µ–π, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π restore —Ç–µ—Å—Ç.

### 10. Redis (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚è≥

- –í–∫–ª—é—á–∏—Ç—å –ø–æ–∑–∂–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–µ–π.
- –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω: —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å Docker, persistence –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

## –≠–¢–ê–ü 3: –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### 11. ‚úÖ –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ - –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

- Prometheus + Grafana + AlertManager + Node Exporter
- –§–∞–π–ª—ã: `docker-compose.monitoring.yml`, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ `configs/`
- –î–∞—à–±–æ—Ä–¥—ã: NestJS App, System Resources, Error Monitoring
- –°–∫—Ä–∏–ø—Ç—ã: `scripts/setup_monitoring.sh`, `scripts/test_monitoring.sh`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `docs/MONITORING_GUIDE.md`

### 12. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚è≥

- SSH: —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏, disable password auth.
- UFW: allow 22,80,443; deny –æ—Å—Ç–∞–ª—å–Ω–æ–µ.
- Swagger –æ—Ç–∫–ª—é—á—ë–Ω (`SWAGGER_ENABLED=0`) –≤ –ø—Ä–æ–¥ ‚úÖ.
- CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Ñ—Ä–æ–Ω—Ç‚Äë–¥–æ–º–µ–Ω–æ–º ‚úÖ.
- Rate limiting –≤–∫–ª—é—á–µ–Ω (–≥–ª–æ–±–∞–ª—å–Ω—ã–π + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏) ‚úÖ.
- –†–µ–≥—É–ª—è—Ä–Ω—ã–µ apt –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è / unattended-upgrades.
- –î–æ—Å—Ç—É–ø –∫ `/metrics` –æ–≥—Ä–∞–Ω–∏—á–µ–Ω ‚úÖ.

## –≠–¢–ê–ü 4: –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï

### 13. –ü–µ—Ä–≤—ã–π –†—É—á–Ω–æ–π –î–µ–ø–ª–æ–π ‚è≥

```
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (–æ–¥–∏–Ω —Ä–∞–∑)
apt update && apt upgrade -y
apt install -y docker.io docker-compose-plugin fail2ban ufw
useradd -m -s /bin/bash deploy
usermod -aG docker deploy
# (Relogin)

mkdir -p /opt/books/{app,uploads,backups}
vim /opt/books/app/.env.prod

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å docker-compose.prod.yml (–∏–∑ —Ä–µ–ø–æ)
# –í–æ–π—Ç–∏ –≤ registry (–µ—Å–ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
docker login <registry>

docker compose --profile prod -f docker-compose.prod.yml pull
docker compose --profile prod -f docker-compose.prod.yml up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞
curl -sf http://127.0.0.1:5000/metrics | head -n 5
# (–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TLS)
curl -sf https://api.example.com/metrics | head -n 5
```

**–°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∞:** –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å email –∏–∑ `ADMIN_EMAILS`.

### 14. –ë—ç–∫–∞–ø—ã ‚è≥

- Cron (–ø—Ä–∏–º–µ—Ä `/etc/cron.d/books_backups`):

```bash
0 2 * * * postgres pg_dump books | gzip > /opt/books/backups/books-$(date +\%F).sql.gz
0 3 * * * root find /opt/books/backups -type f -mtime +14 -delete
```

- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å: `psql books < dump.sql`.

### 15. –ü—Ä–æ—Ü–µ—Å—Å –†–µ–ª–∏–∑–∞ ‚è≥

1. Merge –≤ `main`.
2. CI –∑–µ–ª—ë–Ω—ã–π ‚Üí —Å–æ–∑–¥–∞—ë–º —Ç–µ–≥ `vX.Y.Z`.
3. Build + push –æ–±—Ä–∞–∑ `prod-vX.Y.Z`.
4. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: pull + `docker compose up -d`.
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ health (`GET /metrics` 200).
6. –û–ø–æ–≤–µ—â–µ–Ω–∏–µ —Ñ—Ä–æ–Ω—Ç–∞ (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç).

**Rollback:**

- Pull –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–µ–≥–∞ ‚Üí up -d.
- –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pre-release DB dump.

## –≠–¢–ê–ü 5: –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø

### 16. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ß–µ–∫–ª–∏—Å—Ç –ü–µ—Ä–µ–¥ PROD ‚è≥

- [ ] –î–æ–º–µ–Ω –∏ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä healthy
- [x] `/metrics` –¥–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω ‚úÖ
- [x] Rate limiting –≤–∫–ª—é—á—ë–Ω ‚úÖ
- [x] Swagger –≤—ã–∫–ª—é—á–µ–Ω ‚úÖ
- [ ] –ë—ç–∫–∞–ø cron –∞–∫—Ç–∏–≤–µ–Ω
- [ ] –ê–¥–º–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
- [ ] –û–±—Ä–∞–∑ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω (–≤–µ—Ä—Å–∏—è / —Ç–µ–≥)
- [x] –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ ‚úÖ

### 17. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –§—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º ‚è≥

- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å BASE_API_URL.
- –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å OpenAPI —Ç–∏–ø—ã: `yarn openapi:types:prod` (–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–∏—Ç—å Swagger –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑ staging).
- –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å breaking changes —á–µ—Ä–µ–∑ CHANGELOG.

## –≠–¢–ê–ü 6: –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)

### 18. Staging (–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ) ‚ùå

- –î–æ–º–µ–Ω: `api-staging.example.com`.
- –û—Ç–¥–µ–ª—å–Ω–∞—è –ë–î: `books_staging`.
- –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π –∏–∑ feature merges (develop). –ú–∏–≥—Ä–∞—Ü–∏–∏ –∫–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.
- –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥ (–ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏).

### 19. –î–æ—Å—Ç—É–ø—ã –∏ –ü—Ä–∞–≤–∞ ‚ùå

- –ù–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ Postgres/Redis.
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ DB.
- CI deploy –∫–ª—é—á —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º scp/ssh (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GitLab Deploy Token / GitHub Actions OIDC ‚Üí registry).

### 20. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚ùå

- –î–æ–±–∞–≤–∏—Ç—å –≤ README —Å—Å—ã–ª–∫—É –Ω–∞ DEPLOYMENT.md.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Docker/CI.

## –≠–¢–ê–ü 7: –ë–£–î–£–©–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### 21. –î–∞–ª—å–Ω–µ–π—à–∏–µ –£–ª—É—á—à–µ–Ω–∏—è ‚ùå

- Terraform/IaC.
- Watchtower (—Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é) –∏–ª–∏ GitOps (ArgoCD).
- S3/GCS –¥–ª—è –º–µ–¥–∏–∞.
- ~~Prometheus + Grafana bundle~~ ‚úÖ –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ.
- Centralized logging (Loki / OpenSearch).

---

## –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: 4/21 –ø—É–Ω–∫—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω—ã

**–°–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏:**

1. **–ü—É–Ω–∫—Ç 12** - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—Å–∫—Ä–∏–ø—Ç—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSH, UFW, etc.)
2. **–ü—É–Ω–∫—Ç 14** - –ë—ç–∫–∞–ø—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã –±—ç–∫–∞–ø–∞ PostgreSQL)
3. **–ü—É–Ω–∫—Ç 17** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º (OpenAPI —Ç–∏–ø—ã)

**–û–±–Ω–æ–≤–ª—è–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, CI –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.**

## 22. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¢–∞—Ä–∏—Ñ Quasar + Cloudflare R2)

–ü—Ä–æ—Ñ–∏–ª—å –ø–ª–∞–Ω–∞: 4 vCPU / 6 GB RAM / 120 GB SSD. –ù–∏–∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ ENV –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å –≤–Ω–µ—à–Ω–∏–º –æ–±—ä–µ–∫—Ç–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º (R2) –∏ –±–µ–∑ Redis –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.

### 22.1 –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

- Node/NestJS: 300‚Äì450 MB RAM. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å GC heap: `NODE_OPTIONS=--max-old-space-size=1024`.
- Postgres (~1.5‚Äì2 GB —Ü–µ–ª–µ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ):
  - shared_buffers=1GB
  - effective_cache_size=4GB
  - work_mem=32MB (16MB –µ—Å–ª–∏ –º–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
  - maintenance_work_mem=256MB
  - max_connections=80 (–ø–æ–∑–∂–µ PgBouncer –ø—Ä–∏ —Ä–æ—Å—Ç–µ)
  - wal_compression=on, checkpoint_timeout=15min, max_wal_size=2GB
- Proxy (Nginx/Caddy)+—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ—Ä–æ–Ω—Ç <100 MB.
- –†–µ–∑–µ—Ä–≤ RAM >3 GB –ø–æ–¥ –ø–∏–∫–∏/–º–∏–≥—Ä–∞—Ü–∏–∏/—Ñ–æ–Ω–æ–≤—ã–π –≤–æ—Ä–∫–µ—Ä.

### 22.2 –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—é–Ω–∏–Ω–≥–∏

- Swap 1‚Äì2 GB (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, –Ω–µ —Ä–∞–±–æ—á–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞):
  - `fallocate -l 2G /swapfile && chmod 600 /swapfile && mkswap /swapfile && swapon /swapfile`
  - sysctl: `vm.swappiness=10`, `vm.vfs_cache_pressure=50`.
- `ulimit -n 4096` (Docker ulimit –∏–ª–∏ systemd).
- –õ–æ–≥-—Ä–æ—Ç–∞—Ü–∏—è journald / nginx / app (logrotate –∏–ª–∏ size‚Äë–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).

### 22.3 Cloudflare R2 (S3 API)

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞):

```
R2_ACCOUNT_ID=<id>
R2_ACCESS_KEY_ID=<access_key>
R2_SECRET_ACCESS_KEY=<secret_key>
R2_BUCKET=books-media
R2_ENDPOINT=https://<account_id>.r2.cloudflarestorage.com
R2_PUBLIC_BASE_URL=https://media.example.com
```

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

- –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π bucket, –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –ª–∏—Å—Ç–∏–Ω–≥.
- API token —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏.
- CORS –≤ R2 —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ñ—Ä–æ–Ω—Ç –¥–æ–º–µ–Ω.
- CDN/Custom domain —á–µ—Ä–µ–∑ Cloudflare –¥–ª—è –∫–µ—à–∞.

### 22.4 –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–≥—Ä—É–∑–æ–∫

1. Presigned URL (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): API –≤—ã–¥–∞—ë—Ç PUT URL ‚Üí –∫–ª–∏–µ–Ω—Ç –∑–∞–ª–∏–≤–∞–µ—Ç ‚Üí API `confirm` —Å–æ–∑–¥–∞—ë—Ç `MediaAsset`.
2. –°–µ—Ä–≤–µ—Ä–Ω—ã–π proxy (fallback) ‚Äî –¥–æ—Ä–æ–∂–µ –ø–æ CPU/—Ç—Ä–∞—Ñ–∏–∫—É.
   –ê–¥–∞–ø—Ç–µ—Ä —Ö—Ä–∞–Ω–µ–Ω–∏—è: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `upload/delete/getPublicUrl/presign` + –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–æ–≤.

### 22.5 –ü–æ–ª–∏—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å

- –ù–µ –≤–∫–ª—é—á–∞—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–µ `hash` –≤ `MediaAsset` –¥–ª—è dedup.
- –†–∞–∑–º–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ API (–ª–∏–º–∏—Ç—ã —É–∂–µ –µ—Å—Ç—å ENV).

### 22.6 –ë—ç–∫–∞–ø—ã

- R2 –Ω–µ –±—ç–∫–∞–ø–∏–º –æ—Ç–¥–µ–ª—å–Ω–æ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å); –∫—Ä–∏—Ç–∏—á–Ω–æ ‚Äî –±—ç–∫–∞–ø–∏—Ç—å Postgres (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ `MediaAsset`).
- –ü–æ—Å—Ç–¥–µ–ø–ª–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —Å–ª—É—á–∞–π–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ media ‚Üí –∑–∞–ø—Ä–æ—Å –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL.

### 22.7 –ú–µ—Ç—Ä–∏–∫–∏

- –î–æ–±–∞–≤–∏—Ç—å counters (–ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è): `media_upload_success_total`, `media_upload_fail_total`.
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –∏ —Ä–∞–∑–º–µ—Ä (info) –¥–ª—è –∞—É–¥–∏—Ç–∞.

### 22.8 –ö–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—Ç—å Redis/BullMQ

- –ü–æ—è–≤–∏–ª–∏—Å—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (–∞—É–¥–∏–æ-—Ç—Ä–∞–Ω—Å–∫–æ–¥–∏–Ω–≥, –º–∞—Å—Å–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) –∏–ª–∏ –¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç –∑–∞–ø—Ä–æ—Å—ã.
- –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è: –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–æ—Ä–∫–µ—Ä–∞ + –ª–∏–º–∏—Ç heap `--max-old-space-size=512`.

### 22.9 –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—à–µ Quasar

- CPU >60% —Å—Ä–µ–¥–Ω–µ–µ –ø–æ 4 vCPU –¥–ª–∏—Ç–µ–ª—å–Ω–æ.
- RAM >75% –±–µ–∑ –∫–µ—à–∞ –û–°.
- P99 –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ—Å—Ç—ã—Ö SELECT >20‚Äì30ms.
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞ ‚Üí –≤—ã–Ω–µ—Å—Ç–∏ Postgres –≤ managed + —Ä–µ–ø–ª–∏–∫–∏.

### 22.10 –ß–µ–∫–ª–∏—Å—Ç Quasar + R2

```
[ ] VPS (Quasar) —Å–æ–∑–¥–∞–Ω, –æ–±–Ω–æ–≤–ª—ë–Ω
[ ] Swap 2G + sysctl –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
[ ] Docker/Compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
[ ] Postgres —Ç—é–Ω–∏–Ω–≥ –≤–Ω–µ–¥—Ä—ë–Ω (shared_buffers=1GB ...)
[ ] Bucket R2 —Å–æ–∑–¥–∞–Ω, token –≤—ã–ø—É—â–µ–Ω
[ ] ENV R2_* –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã (–º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ –∫–æ–¥–∞ –∞–¥–∞–ø—Ç–µ—Ä–∞)
[ ] .env.prod –±–µ–∑ Redis –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
[ ] –ü–µ—Ä–≤—ã–π deploy: health OK
[ ] Cron –±—ç–∫–∞–ø–æ–≤ Postgres –∞–∫—Ç–∏–≤–µ–Ω
[ ] –ê–¥–º–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω
```

–°–µ–∫—Ü–∏—è –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –∞–¥–∞–ø—Ç–µ—Ä–∞ R2.
