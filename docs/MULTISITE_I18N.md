# Мультисайт i18n (/:lang) — ТЗ на доработку бэка

Цель: перевести публичный сайт и админские сценарии на модель «мультисайта по языкам» с префиксом пути `/:lang` (en|fr|es|pt), где контент (книги/версии/страницы/SEO) выбирается по языку сайта, а не по `?lang`/`Accept-Language`.

Документ описывает обязательные изменения, опциональные улучшения и пошаговый план итераций.

---

## 1) Текущее состояние (кратко)

- Book — контейнер, язык-нейтральный, `slug @unique`.
- BookVersion — языкоспецифично: `language`, `@@unique([bookId, language])`, поля контента, связи (главы/аудио/пересказ/SEO/категории/теги и пр.).
- Page — есть `language`, но `slug @unique` глобально (не по языку) — конфликт с мультисайтом.
- SEO — привязан к BookVersion и Page (one-to-one), уже совместим с per-language контентом.
- Категории/Теги — язык-нейтральные (`slug @unique`), нет `language` или таблиц переводов.
- Публичные ручки частично читают язык из `?lang`/`Accept-Language`.

Вывод: для книг/версий всё готово. Блокер — `Page.slug @unique` (должен стать уникальным в паре с `language`). Таксономии локализуем по Варианту B (через таблицы переводов) — обязательная часть.

---

## 2) Обязательные изменения

1. Prisma (Page):
   - Удалить `@unique` с поля `slug`.
   - Добавить составной уникальный ключ `@@unique([language, slug])`.
   - Рекомендовано: `@@index([language])`.

2. Роутинг и язык запроса:
   - Ввести префикс `/:lang(en|fr|es|pt)` в публичных маршрутах.
   - Добавить request-scoped резолвер языка из префикса и класть в контекст (например, `req.lang`).
   - Политика выбора языка: префикс пути имеет приоритет над `?lang` и `Accept-Language`; совместимость сохранить как fallback.

3. Контроллеры публичного API:
   - `GET /:lang/books/:slug/overview` и производные — выбирать `BookVersion` по `language = req.lang`.
   - Разделы категорий/тегов по слагу — пока без локализации таксономий; фильтрация версий по `req.lang`.
   - Страницы `GET /:lang/pages/:slug` — искать по паре `(language, slug)`.

4. Тесты (E2E):
   - Добавить сценарии с префиксом языка в пути и приоритетом над заголовками.

---

## 3) Поддержка админки на выбранном языке (бэкенд-часть)

- Выбранная схема URL: `/admin/:lang/...` (например, `/admin/en/pages`, `/admin/fr/books/{id}/versions`).
- Язык в пути валидируется через LangParamPipe; глобальный LanguageResolverGuard уже доступен.
- Листинги:
  - Pages: фильтр по `language` (в текущем MVP список общий; фильтр добавим позже).
  - Books: админ-листинг версий доступен по `/admin/:lang/books/{bookId}/versions` (внутренне язык пока не влияет на выдачу — MVP).
- Создание:
  - Page — принимает `language` в payload; URL префикс `/admin/:lang` используется для контекста UI и аудита.
  - BookVersion — принимает `language` в payload; язык префикса пока не форсирует значение payload (обсуждение на будущее).

Примечание: UI‑часть (веб-админка) не входит, но бек стабилен с языковым контекстом через префикс.

---

## 4) Локализация таксономий (обязательно, выбран Вариант B)

Подход:

- Оставить `Category`/`Tag` как базовые сущности (ID, иерархия для Category).
- Добавить `CategoryTranslation` и `TagTranslation`:
  - Поля: `id`, `categoryId|tagId` (FK), `language` (enum), `name`, `slug`.
  - Уникальность slug: `@@unique([language, slug])` (одинаковые slug допустимы на разных языках, но не в рамках одного языка).
  - Индексы: `@@index([categoryId, language])`, `@@index([tagId, language])`.
  - Связи: `Category.translations: CategoryTranslation[]`, `Tag.translations: TagTranslation[]`.

API:

- Публичные ручки `/:lang/categories/:slug/...` и `/:lang/tags/:slug/...` находят перевод по паре `(language=req.lang, slug)` и далее разрешают базовую сущность (для связей и статистики).
- Админ‑ручки для CRUD категорий/тегов поддерживают управление переводами: создание/обновление/удаление переводов.
- Привязки версий к категориям/тегам не меняются (привязка к базовым сущностям).

---

## 5) Изменения в SEO

- Для `BookVersion` — без изменений: SEO уже one-to-one к версии (а версия — per-language).
- Для `Page` — SEO уже one-to-one; искать по `(language, slug)`.
- `GET /seo/resolve`: добавить учёт языка из пути (или параметра), чтобы резолвить корректный объект.

---

## 6) Совместимость и переход

- На период миграции поддерживаем старые URL без `/:lang` (301/302 или совместимые контроллеры), но новый путь — предпочтительный.
- `Accept-Language` и `?lang` остаются как fallback, но документация фиксирует приоритет префикса.

---

## 7) Итерации внедрения

Итерация 1 — База и маршрутизация (обязательная)

- Prisma миграция: Page slug уникальность → `@@unique([language, slug])`, `@@index([language])`.
- Ввести резолвер языка из `/:lang` + middleware/guard.
- Обновить публичные контроллеры книг/страниц на использование `req.lang`.
- E2E: добавить smoke-тесты для префикса.

Итерация 2 — Админ-контекст языка (бэк)

- Ввести единый способ передавать язык админки (заголовок `X-Admin-Language` или query `adminLang`).
- Pages admin: листинг/создание/обновление с явным `language`.
- Books admin: эндпоинт статуса языков/форматов для книги (агрегация по `BookVersion`).

Итерация 3 — SEO и резолвер

- Обновить `seo/resolve` для учёта языка из пути.
- Добавить e2e на SEO для версий/страниц в разных языках.

Итерация 4 — Таксономии через переводы (\*Translation)

- Prisma: ввести `CategoryTranslation`, `TagTranslation`; добавить связи из базовых сущностей; миграция данных из текущих полей `Category.name/slug` → переводы для дефолтного языка.
- Контроллеры/сервисы: CRUD переводов; публичные выдачи по `(language, slug)` переводов; admin‑листинги с агрегацией по переводам.
- E2E: переводы категорий/тегов на 2 языках, поиск по slug перевода, привязки к версиям.

Итерация 6 — Sitemap/robots per-language (если включён раздел SEO sitemap)

- `GET /sitemap.xml` — отдавать URL с `/:lang` для каждого доступного языка/версии.
- `robots.txt` — без изменений или указать локализованные карты сайта.

---

## 8) Миграции: заметки

- Page: безопасная миграция — дроп `UNIQUE(slug)`, создать `UNIQUE(language, slug)`. Перед применением убедиться, что дубликатов по slug на разных языках пока нет (или выполнить soft reset в dev).
- Таксономии (опционально): заранее обсудить стратегию (A или B). Вариант B предпочтительнее для долгосрочной эволюции.

---

## 9) Риски и edge cases

- Отсутствует версия книги в выбранном языке — возвращать 404 или фолбэк (решение продукта; по умолчанию 404 для строгого мультисайта).
- Страницы без перевода — 404 на конкретном языке.
- Категории/теги без локализации (если опция отложена) — названия будут одинаковыми на всех языках.
- E2E/клиенты могут полагаться на старые URL — подготовить переадресации/совместимость.

---

## 10) Критерии приёмки (MVP мультисайта)

- Публичные URL вида `/:lang/...` возвращают контент соответствующего языка: книги (обзор/read/listen/summary), страницы.
- Админ‑листинги и создание объектов позволяют явно указывать/фильтровать по языку.
- Page поддерживает одинаковые `slug` на разных языках (уникальность в паре с `language`).
- Тесты покрывают выбор языка из префикса и приоритет над заголовками.
- Категории и теги локализованы: поиск по `(language, slug)` на публичных ручках, CRUD переводов в админке, корректные привязки к версиям.
