# Reverse Proxy Setup - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

## –§–∞–π–ª—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ reverse proxy

### üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

- `configs/Caddyfile.prod` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Caddy –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- `scripts/install_caddy.sh` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Caddy
- `scripts/test_reverse_proxy.sh` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã reverse proxy

### üìù –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

- `docker-compose.prod.yml` - —É–±—Ä–∞–Ω –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ—Ä—Ç 5000
- `.env.prod` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã URL –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å proxy

## –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- ‚úÖ –ü—É–Ω–∫—Ç 6 (–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è) –≤—ã–ø–æ–ª–Ω–µ–Ω
- ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–ø—É—â–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- üåê DNS A-–∑–∞–ø–∏—Å—å `api.example.com` –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ IP —Å–µ—Ä–≤–µ—Ä–∞
- üî• –ü–æ—Ä—Ç—ã 80 –∏ 443 –æ—Ç–∫—Ä—ã—Ç—ã –≤ –æ–±–ª–∞—á–Ω–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
cd /opt/books/app/src

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã)
# git pull  # –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é configs/ –∏ scripts/
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Caddy:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–æ—Ç sudo)
sudo ./scripts/install_caddy.sh
```

–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç:

- –£—Å—Ç–∞–Ω–æ–≤–∫—É Caddy –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ `configs/Caddyfile.prod`
- –ù–∞—Å—Ç—Ä–æ–π–∫—É —Ñ–∞–π—Ä–≤–æ–ª–∞ (–ø–æ—Ä—Ç—ã 80, 443)
- –ü—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.prod.yml up -d

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ
curl -I http://localhost:5000/api/health/liveness  # –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã reverse proxy
./scripts/test_reverse_proxy.sh api.example.com
```

–ò–ª–∏ —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:

```bash
# HTTPS –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
curl -I https://api.example.com/api/health/liveness

# HTTP –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ HTTPS
curl -I http://api.example.com

# Metrics –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
curl -I https://api.example.com/api/metrics  # 403 Forbidden

# WWW –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å
curl -I http://www.api.example.com
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Caddy

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π HTTPS**:
   - Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
   - HSTS –∑–∞–≥–æ–ª–æ–≤–∫–∏

2. **Reverse Proxy**:
   - –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ `api.example.com` ‚Üí `localhost:5000`
   - –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
   - Rate limiting (100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É –Ω–∞ IP)
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ `/api/metrics` –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
   - –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (XSS, CSRF, etc.)

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - JSON —Ñ–æ—Ä–º–∞—Ç –≤ `/var/log/caddy/api.log`
   - –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ (100MB, 5 —Ñ–∞–π–ª–æ–≤)

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```bash
# –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
systemctl status caddy

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
journalctl -u caddy -f

# –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞
tail -f /var/log/caddy/api.log

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
caddy validate --config /etc/caddy/Caddyfile
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –í–∫–ª—é—á–µ–Ω–æ:

- HTTPS –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ (HSTS)
- Rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ proxy
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ metrics endpoint
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞–ø—Ä—è–º—É—é (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ proxy)

### ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Caddy
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å alerting –Ω–∞ 5xx –æ—à–∏–±–∫–∏
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

## Troubleshooting

### Caddy –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo caddy validate --config /etc/caddy/Caddyfile

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
sudo journalctl -u caddy -n 50
```

### 502 Bad Gateway:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
curl -I http://localhost:5000/api/health/liveness

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose -f docker-compose.prod.yml ps
```

### Let's Encrypt –æ—à–∏–±–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–æ–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
nslookup api.example.com

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç—ã
sudo ufw status
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ reverse proxy:

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (–ü—É–Ω–∫—Ç 11 DEPLOYMENT.md)
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã** (–ü—É–Ω–∫—Ç 18)
3. **–°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º**

---

–û–±–Ω–æ–≤–ª–µ–Ω–æ: 2025-09-27  
–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
