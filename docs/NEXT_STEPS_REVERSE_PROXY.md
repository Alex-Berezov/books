# Deployment Plan: Reverse Proxy Setup (–ü—É–Ω–∫—Ç 7 DEPLOYMENT.md)

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (27.09.2025)

### ‚úÖ –ß—Ç–æ –î–û–õ–ñ–ù–û –ë–´–¢–¨ –ó–ê–í–ï–†–®–ï–ù–û –ü–ï–†–ï–î –≠–¢–ò–ú –≠–¢–ê–ü–û–ú:

1. **–ü—É–Ω–∫—Ç 3 - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (‚úÖ –ó–ê–í–ï–†–®–ï–ù–û):**
   - NestJS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 5000
   - PostgreSQL –∑–∞–ø—É—â–µ–Ω –∏ healthy
   - –ú–∏–≥—Ä–∞—Ü–∏–∏ Prisma –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (23 migrations)
   - Entrypoint —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

2. **–ü—É–Ω–∫—Ç 6 - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (üìã –î–û–õ–ñ–ù–û –ë–´–¢–¨ –°–î–ï–õ–ê–ù–û –°–ù–ê–ß–ê–õ–ê!):**
   - .env.prod –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
   - SWAGGER_ENABLED=0, RATE_LIMIT_GLOBAL_ENABLED=1, TRUST_PROXY=1
   - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ JWT_SECRET –∏ DATABASE_URL
   - –°–º. –ø–ª–∞–Ω –≤ NEXT_STEPS_ENVIRONMENT.md

3. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
   - **TypeScript –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –î–æ–±–∞–≤–ª–µ–Ω `rootDir: "./src"` –≤ tsconfig.json
   - **NestJS —Å–±–æ—Ä–∫–∞**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `nest build --webpack` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ dist/main.js
   - **ESLint –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –°–æ–∑–¥–∞–Ω tsconfig.eslint.json –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ—Å—Ç–∞–º–∏
   - **Docker entrypoint**: –£–ø—Ä–æ—â–µ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ dist/main.js –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –ø—É—Ç–∏

4. **–°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤:**
   - –õ–æ–∫–∞—Ü–∏—è: `/opt/books/app/src`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: `deploy`
   - Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
   - Docker Compose –∑–∞–ø—É—â–µ–Ω —Å prod –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

### üîß –¢–µ–∫—É—â–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –º–µ–ª–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. Healthcheck –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç unhealthy (–∏—â–µ—Ç `/metrics`, –ø–æ–ª—É—á–∞–µ—Ç 404)
2. Endpoint –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `/api/metrics` –≤–º–µ—Å—Ç–æ `/metrics`

## –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: Reverse Proxy + HTTPS (–ü—É–Ω–∫—Ç 7 –∏–∑ DEPLOYMENT.md)

### –¶–µ–ª—å:

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Caddy reverse proxy –¥–ª—è:

1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ HTTPS —á–µ—Ä–µ–∑ Let's Encrypt
2. –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è `api.example.com` ‚Üí –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 5000
3. –ë–∞–∑–æ–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ rate limiting

### –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

#### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ–º–µ–Ω–∞

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å DNS A-–∑–∞–ø–∏—Å—å `api.example.com` ‚Üí IP —Å–µ—Ä–≤–µ—Ä–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–æ–º–µ–Ω–∞: `dig +short api.example.com`
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ—Ä—Ç—ã 80/443 –æ—Ç–∫—Ä—ã—Ç—ã –≤ UFW

#### –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Caddy

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Caddy
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status caddy
```

#### –®–∞–≥ 3: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Caddy

–°–æ–∑–¥–∞—Ç—å `/etc/caddy/Caddyfile`:

```caddy
api.example.com {
    reverse_proxy localhost:5000

    # –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–¥—É–±–ª–∏—Ä—É—é—Ç —Ç–æ —á—Ç–æ –µ—Å—Ç—å –≤ NestJS, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
    header {
        # Remove server info
        -Server

        # Security headers
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin

        # CORS (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –Ω–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
        # Access-Control-Allow-Origin https://frontend.example.com
    }

    # Rate limiting (–±–∞–∑–æ–≤—ã–π)
    rate_limit {
        zone dynamic_rl {
            key {remote_host}
            events 100
            window 1m
        }
    }

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    log {
        output file /var/log/caddy/api.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }

    # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è metrics endpoint (–æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø)
    @metrics path /api/metrics
    respond @metrics "Metrics endpoint disabled" 403
}

# –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å www
www.api.example.com {
    redir https://api.example.com{uri}
}
```

#### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞

```bash
# –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã –¥–ª—è HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
sudo ufw status
```

#### –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo caddy validate --config /etc/caddy/Caddyfile

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Caddy
sudo systemctl enable caddy
sudo systemctl start caddy

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status caddy

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
sudo journalctl -u caddy -f
```

#### –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–æ–º–µ–Ω –æ—Ç–≤–µ—á–∞–µ—Ç
curl -I https://api.example.com/api/health/liveness

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç
curl -I https://api.example.com

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ metrics –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
curl -I https://api.example.com/api/metrics

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTTP ‚Üí HTTPS
curl -I http://api.example.com
```

#### –®–∞–≥ 7: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docker-compose.prod.yml

- [ ] –£–±—Ä–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ—Ä—Ç 5000 (–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å healthcheck –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å `/api/metrics`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è TRUST_PROXY

#### –®–∞–≥ 8: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–û–±–Ω–æ–≤–∏—Ç—å `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# –î–æ–±–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å
TRUST_PROXY=1
CORS_ORIGIN=https://frontend.example.com  # –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω —Ñ—Ä–æ–Ω—Ç–∞
LOCAL_PUBLIC_BASE_URL=https://api.example.com/static
SWAGGER_ENABLED=0
```

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. `/etc/caddy/Caddyfile` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Caddy
2. `docker-compose.prod.yml` - —É–±—Ä–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –ø–æ—Ä—Ç
3. `.env` - –æ–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

- `https://api.example.com/api/health/liveness` ‚Üí 200 OK
- `https://api.example.com/api/metrics` ‚Üí 403 Forbidden (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π HTTPS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç Let's Encrypt
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω, –Ω–µ —á–µ—Ä–µ–∑ IP:5000

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:

1. **DNS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å A-–∑–∞–ø–∏—Å—å, –ø–æ–¥–æ–∂–¥–∞—Ç—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
2. **Let's Encrypt –æ—à–∏–±–∫–∏**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–æ–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ, –ø–æ—Ä—Ç—ã 80/443 –æ—Ç–∫—Ä—ã—Ç—ã
3. **502 Bad Gateway**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ localhost:5000
4. **CORS –æ—à–∏–±–∫–∏**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS_ORIGIN –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

### –°–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã –ø–æ—Å–ª–µ Reverse Proxy:

1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ø—É–Ω–∫—Ç 11 DEPLOYMENT.md)
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤ (–ø—É–Ω–∫—Ç 18)
3. –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º (–ø—É–Ω–∫—Ç 20)
5. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Docker –æ–±—Ä–∞–∑–∞

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è:

- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å `api.example.com` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `CORS_ORIGIN` –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `/api/metrics` –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ—Ä—Ç—ã 80/443 –æ—Ç–∫—Ä—ã—Ç—ã –≤ –æ–±–ª–∞—á–Ω–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ (–Ω–µ —Ç–æ–ª—å–∫–æ UFW)

---

–§–∞–π–ª —Å–æ–∑–¥–∞–Ω: 2025-09-27, —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω, –≥–æ—Ç–æ–≤—ã –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É.
