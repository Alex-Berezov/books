# Контекст и правила для ИИ-агента (AGENT_CONTEXT)

Цель документа — дать краткие и однозначные правила ведения работ в этом репозитории: стиль, формат PR, границы изменений, порядок работы с миграциями и тестами. Держим документ лаконичным и актуальным.

## Золотые правила

- Используем только Yarn (classic) 1.x. npm не используем.
- Минимизируйте диффы: не форматируйте несвязанные файлы, не меняйте публичные API без необходимости.
- Каждую задачу завершайте «зелёной»: линт, типы, сборка/запуск и тесты должны проходить локально.
- Обновляйте документацию при каждом изменении поведения: README, соответствующие docs/\*, CHANGELOG, и отметки в `docs/ITERATION_TASKS.md`.

## Контракт итерации (что считать «сделано»)

Перед завершением итерации убедитесь, что:

1. Реализована функциональность в минимально достаточном объёме.
2. Добавлены/обновлены тесты: минимум happy-path + 1 edge-case (для e2e или unit — по ситуации).
3. Документация обновлена (README, профильные docs/\*, CHANGELOG).
4. В `docs/ITERATION_TASKS.md` пункт помечен выполненным с датой и краткими деталями.
5. Нет ошибок линтера/типов: `yarn lint`, `yarn typecheck`.
6. Быстрый локальный smoke: приложение стартует (`yarn start:dev`) или проходит соответствующий тест.

## Стиль и соглашения кода

- NestJS + TypeScript. Следуем модульной структуре (modules/feature → controller/service/dto).
- Валидируем входные данные через class-validator, DTO держим строгими.
- Исключения бросаем через стандартные Nest HTTP-исключения.
- Валидации slug и другие общие правила — переиспользуем из `src/shared/*` (не дублируем логику).
- Экспортируем минимально необходимое; избегаем циклических зависимостей.

## Тесты

- Запуск:
  - Unit: `yarn test`
  - E2E: `yarn test:e2e` (в dev режим последовательный, см. jest-e2e конфиг)
  - Один e2e-файл: `yarn test:e2e -- <file>.e2e-spec.ts`
- Добавляйте короткие и устойчивые тесты. Для новых ручек — хотя бы 1-2 сценария.
- Предпочтение быстрым unit там, где можно замокать Prisma/кэш.
- E2E используйте для сквозных проверок маршрутов и политик (язык, статус публикации, SEO и т.п.).

## Миграции Prisma и клиент

- Dev: создаём миграции локально и коммитим в `prisma/migrations/*`.
- Генерация клиента: `yarn prisma:generate` (output зафиксирован в schema.prisma — не менять).
- Применение миграций: `yarn prisma:migrate` для dev-среды.
- Конфликты/дрейф: если встречаются дублирующиеся индексы, правим SQL на идемпотентность (`CREATE UNIQUE INDEX IF NOT EXISTS ...`) и при необходимости делаем dev reset.
- В неинтерактивной среде миграции не создаём. Для CI/production — используем «deploy»-подход (будет добавлен в задачах Docker/CI).

## Переменные окружения

- Минимум: `DATABASE_URL`.
- Опциональные: PORT, HOST, DEFAULT_LANGUAGE, LOCAL_UPLOADS_DIR, LOCAL_PUBLIC_BASE_URL, лимиты upload и кэш (см. README).
- При добавлении новых ключей — обновите README и `.env.example` (после выполнения задачи 6 по расширению примера).

## VS Code задачи

- Используйте преднастроенные задачи `.vscode/tasks.json` для типичных операций: dev, lint, typecheck, prisma, e2e.
- Фоновые задачи (`dev`, `prisma:studio`) не блокируют терминал; останавливаются через Kill Task.

## Изменения API и документация

- Любое изменение публичных ручек сопровождайте:
  - Обновлением Swagger (декораторы, DTO),
  - Краткой записью в `docs/ENDPOINTS.md` или профильном документе,
  - Пунктом в CHANGELOG.

## Шаблон PR (суммарно)

Заголовок: кратко и по делу.  
Описание:

- Что и почему изменилось (motivation + краткие детали реализации).
- Ссылки на задачи из `docs/ITERATION_TASKS.md` (например: «12. 4 — AGENT_CONTEXT»).
- Скриншоты/пример ответа (опц.).

Чеклист перед PR:

- [ ] Линт/формат/типы зелёные: `yarn lint` / `yarn typecheck`
- [ ] Тесты зелёные: `yarn test` и/или `yarn test:e2e`
- [ ] Миграции (если менялась схема): созданы и применены в dev; клиент сгенерирован
- [ ] Документация обновлена (README + профильные docs/\* + CHANGELOG)
- [ ] В `docs/ITERATION_TASKS.md` отмечен прогресс/выполнение

## Границы и безопасность

- Не коммитим секреты.
- Не меняем политики безопасности (Helmet/CORS/лимиты тела) вне соответствующей задачи.
- Не расширяем область задачи без фиксации в `docs/ITERATION_TASKS.md`.

## Быстрые команды

```bash
# типовой dev-поток
yarn
yarn prisma:migrate
yarn prisma:generate
yarn start:dev

# проверки
yarn lint
yarn typecheck
yarn test
yarn test:e2e -- <file>.e2e-spec.ts
```

## Эволюция документа

Если правила меняются, дополняйте этот файл и ссылочные разделы README/ITERATION_TASKS/CHANGELOG. Краткость и практичность — приоритет.
