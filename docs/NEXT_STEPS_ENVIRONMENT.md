# Deployment Plan: Environment Variables Setup (–ü—É–Ω–∫—Ç 6 DEPLOYMENT.md)

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (27.09.2025)

### ‚úÖ –ß—Ç–æ –ó–ê–í–ï–†–®–ï–ù–û:

- –ü—É–Ω–∫—Ç 1: –î–æ–º–µ–Ω—ã –∏ DNS (–±—É–¥–µ–º –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–æ–∑–∂–µ)
- –ü—É–Ω–∫—Ç 2: VPS/–°–µ—Ä–≤–µ—Ä (–Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å deploy, Docker —Ä–∞–±–æ—Ç–∞–µ—Ç)
- –ü—É–Ω–∫—Ç 3: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (‚úÖ –ì–û–¢–û–í–û - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç)

### ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û: –ü—É–Ω–∫—Ç 6 - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

## –¶–µ–ª—å: (–í–´–ü–û–õ–ù–ï–ù–ê)

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—É–Ω–∫—Ç—É 6 DEPLOYMENT.md

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (2025-09-27):

### –°–æ–∑–¥–∞–Ω .env.prod —Ñ–∞–π–ª —Å –ø—Ä–æ–¥–∞–∫—à–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:

- ‚úÖ NODE_ENV=production
- ‚úÖ SWAGGER_ENABLED=0 (–æ—Ç–∫–ª—é—á–∏—Ç—å Swagger –≤ –ø—Ä–æ–¥–µ)
- ‚úÖ RATE_LIMIT_GLOBAL_ENABLED=1 (–≤–∫–ª—é—á–∏—Ç—å rate limiting)
- ‚úÖ TRUST_PROXY=1 (–¥–ª—è —Ä–∞–±–æ—Ç—ã –∑–∞ reverse proxy)
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ JWT_ACCESS_SECRET –∏ JWT_REFRESH_SECRET (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã openssl)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π DATABASE_URL –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- ‚úÖ CORS_ORIGIN –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- ‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ 600 (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å)

### –û–±–Ω–æ–≤–ª–µ–Ω docker-compose.prod.yml:

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç .env.prod –≤–º–µ—Å—Ç–æ .env
- ‚úÖ Healthcheck –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å /api/metrics

### –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:

- ‚úÖ /api/metrics - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ /api/health/liveness - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ /api/health/readiness - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –í—Å–µ —Ä–æ—É—Ç—ã –∏–º–µ—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å /api (app.setGlobalPrefix('api'))

## –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ —Å–µ–π—á–∞—Å –≤ .env
deploy@server1:/opt/books/app/src$ cat .env
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å .env.prod —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `/opt/books/app/src/.env.prod` –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –∏–∑ DEPLOYMENT.md:

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
DATABASE_URL=postgresql://app_user:STRONG_PASS@postgres:5432/books_app?schema=public
PORT=5000
HOST=0.0.0.0
NODE_ENV=production

# –Ø–∑—ã–∫ –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
DEFAULT_LANGUAGE=en

# URL –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (–±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø–æ—Å–ª–µ reverse proxy)
LOCAL_PUBLIC_BASE_URL=https://api.example.com/static

# CORS (–±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–º–µ–Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞)
CORS_ORIGIN=https://frontend.example.com

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –í–ê–ñ–ù–û –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
SWAGGER_ENABLED=0
RATE_LIMIT_GLOBAL_ENABLED=1
TRUST_PROXY=1

# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∞/—Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
ADMIN_EMAILS=admin@example.com
CONTENT_MANAGER_EMAILS=editor@example.com

# JWT —Å–µ–∫—Ä–µ—Ç (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π!)
JWT_SECRET=<SECURE_RANDOM_STRING>

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ Redis/BullMQ (–ø–æ–∫–∞ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å)
# REDIS_HOST=redis
# REDIS_PORT=6379
# BULLMQ_IN_PROCESS_WORKER=0
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å docker-compose.prod.yml

–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π .env —Ñ–∞–π–ª:

```yaml
services:
  app:
    env_file:
      - .env.prod # –≤–º–µ—Å—Ç–æ .env
```

### –®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JWT —Å–µ–∫—Ä–µ—Ç
openssl rand -base64 32

# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
openssl rand -base64 20
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:

- [ ] `NODE_ENV=production`
- [ ] `SWAGGER_ENABLED=0` (–æ—Ç–∫–ª—é—á–∏—Ç—å Swagger –≤ –ø—Ä–æ–¥–µ)
- [ ] `RATE_LIMIT_GLOBAL_ENABLED=1` (–≤–∫–ª—é—á–∏—Ç—å rate limiting)
- [ ] `TRUST_PROXY=1` (–¥–ª—è —Ä–∞–±–æ—Ç—ã –∑–∞ reverse proxy)
- [ ] –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π `DATABASE_URL`
- [ ] –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π `JWT_SECRET`

### –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É

```bash
# –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ .env —Ñ–∞–π–ª—É
chmod 600 /opt/books/app/src/.env.prod
chown deploy:deploy /opt/books/app/src/.env.prod
```

### –®–∞–≥ 7: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –Ω–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

```bash
cd /opt/books/app/src
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.prod.yml up -d
```

### –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker compose -f docker-compose.prod.yml ps

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ API –æ—Ç–≤–µ—á–∞–µ—Ç
curl -I http://localhost:5000/api/health/liveness

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Swagger –æ—Ç–∫–ª—é—á–µ–Ω (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 404)
curl -I http://localhost:5000/api

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
docker compose -f docker-compose.prod.yml logs -f app | head -20
```

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- **JWT_SECRET** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏ –¥–ª–∏–Ω–Ω—ã–º (32+ —Å–∏–º–≤–æ–ª–∞)
- **DATABASE_URL** –Ω–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏
- **.env.prod** –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∞–≤–∞ 600 (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å)
- **Swagger –æ—Ç–∫–ª—é—á–µ–Ω** –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### üåê –î–æ–º–µ–Ω—ã (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è):

- `api.example.com` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω API
- `frontend.example.com` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- –ü–æ–∫–∞ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å example.com, –æ–±–Ω–æ–≤–∏–º –∫–æ–≥–¥–∞ –±—É–¥—É—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–æ–º–µ–Ω—ã

### üìã –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:

- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] Swagger –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (404 –Ω–∞ /api)
- [ ] Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞
- [ ] –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## ‚úÖ –≠–¢–ê–ü –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!

### üöÄ –ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É:

**–ü—É–Ω–∫—Ç 7: Reverse Proxy / TLS** (–ø–ª–∞–Ω –µ—Å—Ç—å –≤ NEXT_STEPS_REVERSE_PROXY.md)

### üìã –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤—Å–µ ‚úÖ):

- [x] NODE_ENV=production
- [x] SWAGGER_ENABLED=0 (–æ—Ç–∫–ª—é—á–µ–Ω –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
- [x] RATE_LIMIT_GLOBAL_ENABLED=1 (–≤–∫–ª—é—á–µ–Ω rate limiting)
- [x] TRUST_PROXY=1 (–¥–ª—è —Ä–∞–±–æ—Ç—ã –∑–∞ reverse proxy)
- [x] JWT —Å–µ–∫—Ä–µ—Ç—ã 44+ —Å–∏–º–≤–æ–ª–æ–≤ (–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ)
- [x] DATABASE_URL –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ PostgreSQL
- [x] docker-compose.prod.yml –∏—Å–ø–æ–ª—å–∑—É–µ—Ç .env.prod
- [x] Healthcheck –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å /api/metrics
- [x] –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ 600 –Ω–∞ .env.prod —Ñ–∞–π–ª

### üõ†Ô∏è –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

- `.env.prod` - –ø—Ä–æ–¥–∞–∫—à–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `test_prod_settings.sh` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `check_prod_config.js` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### üîß –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

- `docker-compose.prod.yml` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç .env.prod + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω healthcheck

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å .env.prod
2. **–ë–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å DATABASE_URL
3. **JWT –æ—à–∏–±–∫–∏** - —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ JWT_SECRET —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
4. **CORS –æ—à–∏–±–∫–∏** - –ø–æ–∫–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –∏—Å–ø—Ä–∞–≤–∏–º –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥

---

–°–æ–∑–¥–∞–Ω: 2025-09-27  
–°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é  
–°–ª–µ–¥—É–µ—Ç –ø–æ—Å–ª–µ: –ü—É–Ω–∫—Ç 3 (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã) ‚úÖ  
–ü–µ—Ä–µ–¥: –ü—É–Ω–∫—Ç 7 (Reverse Proxy)
