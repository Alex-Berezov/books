# ADR: Языки — политика выбора и расширяемость набора

Дата: 2025-08-26

Контекст:

- В проекте языки используются в `BookVersion.language`, `User.languagePreference`, `Page.language` и др. На текущий момент они определены через Prisma enum `Language` (en, es, fr, pt).
- Нужна устойчивая политика выбора версии по языку и возможность расширять список поддерживаемых языков.

Решение:

1. Источник правды о языках — Prisma enum `Language`.

- Добавление нового языка выполняется обычной миграцией Prisma (изменение enum в `schema.prisma`).
- Плюсы: простота, статическая типизация, понятные миграции; минусы: для добавления языка требуется миграция.

2. Политика выбора языка в API:

- Приоритет источников: `?lang` → `Accept-Language` → `DEFAULT_LANGUAGE` (env, по умолчанию `en`).
- Если выбранный язык отсутствует среди доступных у конкретной книги/страницы — используем следующий источник; если ни один не доступен — выбираем первый доступный.
- Реализация инкапсулирована в `src/shared/language/language.util.ts`:
  - `parseAcceptLanguage(header)` — простой парсер с учётом q-factor.
  - `resolveRequestedLanguage({ queryLang, acceptLanguage, available })` — основной резолвер языка.

Рассмотренные альтернативы:

- Таблица `Language` + string-коды в моделях. Плюсы: динамическое управление без миграций; минусы: усложнение схемы, валидации и кода, отсутствие статической типизации enum.
- Промежуточный гибрид (enum + справочник) признан излишним на данном этапе.

Статус: принято и реализовано.

Последствия:

- Для добавления новых языков требуется простая миграция enum; код и тесты готовы к расширению.
- Точки применения политики можно постепенно подключать в других публичных ручках при необходимости.
