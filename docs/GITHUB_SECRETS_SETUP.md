# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Secrets –¥–ª—è Production Deployment

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –≤ production.

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã

### 1. `ENV_PROD` - Production Environment Variables

–°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è production —Å–µ—Ä–≤–µ—Ä–∞.

#### –°–æ–∑–¥–∞–Ω–∏–µ ENV_PROD

1. **–°–æ–∑–¥–∞–π—Ç–µ `.env.prod` –ª–æ–∫–∞–ª—å–Ω–æ**:

   ```bash
   cp .env.prod.template .env.prod
   ```

2. **–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**:

   ```bash
   vim .env.prod  # –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
   ```

   –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç–µ:
   - **DATABASE_URL** - —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL:
     ```
     postgresql://books_app:YOUR_STRONG_PASSWORD@postgres:5432/books_app?schema=public
     ```
     ‚ö†Ô∏è **–í–ê–ñ–ù–û**: –ü–∞—Ä–æ–ª—å –ù–ï –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã `/`, `=`, `@` (Prisma –Ω–µ –º–æ–∂–µ—Ç –∏—Ö –ø–∞—Ä—Å–∏—Ç—å)
   - **JWT Secrets** - —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–∏–ª—å–Ω—ã–µ –∫–ª—é—á–∏:
     ```bash
     openssl rand -base64 32  # –¥–ª—è JWT_ACCESS_SECRET
     openssl rand -base64 32  # –¥–ª—è JWT_REFRESH_SECRET
     ```
   - **ADMIN_EMAILS** - —Ä–µ–∞–ª—å–Ω—ã–µ email –∞–¥—Ä–µ—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:
     ```
     ADMIN_EMAILS=admin@yourdomain.com,admin2@yourdomain.com
     ```
   - **LOCAL_PUBLIC_BASE_URL** - URL –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤:
     ```
     LOCAL_PUBLIC_BASE_URL=https://api.yourdomain.com/static
     ```
   - **CORS_ORIGIN** - —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ frontend –¥–æ–º–µ–Ω—ã:
     ```
     CORS_ORIGIN=https://yourdomain.com,https://app.yourdomain.com
     ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é**:

   ```bash
   # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ CHANGE_THIS –∑–∞–º–µ–Ω–µ–Ω—ã
   grep -i "CHANGE_THIS" .env.prod
   # –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!

   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç DATABASE_URL
   grep "DATABASE_URL" .env.prod
   ```

4. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞**:

   ```bash
   cat .env.prod
   # –í—ã–¥–µ–ª–∏—Ç–µ –≤–µ—Å—å –≤—ã–≤–æ–¥ –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
   ```

5. **–î–æ–±–∞–≤—å—Ç–µ –≤ GitHub Secrets**:
   - –û—Ç–∫—Ä–æ–π—Ç–µ: `https://github.com/Alex-Berezov/books/settings/secrets/actions`
   - –ù–∞–∂–º–∏—Ç–µ **"New repository secret"**
   - **Name**: `ENV_PROD`
   - **Secret**: –≤—Å—Ç–∞–≤—å—Ç–µ **–ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ** —Ñ–∞–π–ª–∞ `.env.prod`
   - –ù–∞–∂–º–∏—Ç–µ **"Add secret"**

6. **–£–¥–∞–ª–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏):
   ```bash
   shred -u .env.prod  # Linux
   # –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª
   ```

### 2. `DEPLOY_SSH_KEY` - SSH –∫–ª—é—á –¥–ª—è –¥–µ–ø–ª–æ—è

–ü—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ production —Å–µ—Ä–≤–µ—Ä—É.

#### –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

1. **–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ ED25519 SSH –∫–ª—é—á**:

   ```bash
   ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/deploy_ed25519
   ```

   - –û—Å—Ç–∞–≤—å—Ç–µ passphrase –ø—É—Å—Ç—ã–º (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏)

2. **–î–æ–±–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ production —Å–µ—Ä–≤–µ—Ä**:

   ```bash
   # –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
   cat ~/.ssh/deploy_ed25519.pub

   # –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ (–æ—Ç –∏–º–µ–Ω–∏ deploy –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
   ssh deploy@bibliaris.com
   mkdir -p ~/.ssh
   chmod 700 ~/.ssh
   echo "–ü–£–ë–õ–ò–ß–ù–´–ô_–ö–õ–Æ–ß_–°–Æ–î–ê" >> ~/.ssh/authorized_keys
   chmod 600 ~/.ssh/authorized_keys
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**:

   ```bash
   ssh -i ~/.ssh/deploy_ed25519 deploy@bibliaris.com "echo 'SSH OK'"
   ```

4. **–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ GitHub Secrets**:

   ```bash
   # –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
   cat ~/.ssh/deploy_ed25519
   # –í—ã–¥–µ–ª–∏—Ç–µ –≤–µ—Å—å –≤—ã–≤–æ–¥ (–≤–∫–ª—é—á–∞—è BEGIN/END —Å—Ç—Ä–æ–∫–∏)
   ```

   - –û—Ç–∫—Ä–æ–π—Ç–µ: `https://github.com/Alex-Berezov/books/settings/secrets/actions`
   - –ù–∞–∂–º–∏—Ç–µ **"New repository secret"**
   - **Name**: `DEPLOY_SSH_KEY`
   - **Secret**: –≤—Å—Ç–∞–≤—å—Ç–µ **–≤–µ—Å—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á**
   - –ù–∞–∂–º–∏—Ç–µ **"Add secret"**

5. **–£–¥–∞–ª–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```bash
   shred -u ~/.ssh/deploy_ed25519
   ```

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ Variables

GitHub Variables (–Ω–µ —Å–µ–∫—Ä–µ—Ç—ã, –Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã):

### 1. `PRODUCTION_SERVER`

–ê–¥—Ä–µ—Å production —Å–µ—Ä–≤–µ—Ä–∞:

```
bibliaris.com
```

### 2. `PRODUCTION_DOMAIN`

–î–æ–º–µ–Ω production API:

```
bibliaris.com
```

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Variables

1. –û—Ç–∫—Ä–æ–π—Ç–µ: `https://github.com/Alex-Berezov/books/settings/variables/actions`
2. –ù–∞–∂–º–∏—Ç–µ **"New repository variable"**
3. –î–æ–±–∞–≤—å—Ç–µ –æ–±–∞ variable —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤

–í `https://github.com/Alex-Berezov/books/settings/secrets/actions` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:

- ‚úÖ `ENV_PROD`
- ‚úÖ `DEPLOY_SSH_KEY`

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Variables

–í `https://github.com/Alex-Berezov/books/settings/variables/actions` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:

- ‚úÖ `PRODUCTION_SERVER`
- ‚úÖ `PRODUCTION_DOMAIN`

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –¥–µ–ø–ª–æ–π

–ß–µ—Ä–µ–∑ GitHub Actions:

1. –û—Ç–∫—Ä–æ–π—Ç–µ: `https://github.com/Alex-Berezov/books/actions/workflows/deploy.yml`
2. –ù–∞–∂–º–∏—Ç–µ **"Run workflow"**
3. –í—ã–±–µ—Ä–∏—Ç–µ `main` branch
4. –ù–∞–∂–º–∏—Ç–µ **"Run workflow"**

–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–¥–µ–ª–∞–π—Ç–µ push –≤ `main`:

```bash
git push origin main
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

–ï—Å–ª–∏ –≤—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≤ –ª–æ–≥–∞—Ö –¥–µ–ø–ª–æ—è –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
üìù Creating .env.prod from secrets...
‚úÖ .env.prod created successfully
üöÄ Starting deployment...
‚úÖ Deployment completed!
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å

- ‚ùå **–ù–ï –∫–æ–º–º–∏—Ç—å—Ç–µ** `.env.prod` –≤ Git
- ‚ùå **–ù–ï –¥–µ–ª–∏—Ç–µ—Å—å** —Å–æ–¥–µ—Ä–∂–∏–º—ã–º GitHub Secrets
- ‚ùå **–ù–ï –∫–æ–ø–∏—Ä—É–π—Ç–µ** —Å–µ–∫—Ä–µ—Ç—ã –≤ –Ω–µ–∑–∞—â–∏—â—ë–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ (Slack, email, etc)
- ‚ùå **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** —Å–ª–∞–±—ã–µ –ø–∞—Ä–æ–ª–∏ –∏–ª–∏ –∫–ª—é—á–∏

### Best Practices

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **—Å–∏–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏** (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ **—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ** JWT —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ **—Ä–æ—Ç–∏—Ä—É–π—Ç–µ** —Å–µ–∫—Ä–µ—Ç—ã (–∫–∞–∂–¥—ã–µ 3-6 –º–µ—Å—è—Ü–µ–≤)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **ED25519** –≤–º–µ—Å—Ç–æ RSA –¥–ª—è SSH –∫–ª—é—á–µ–π
- ‚úÖ –•—Ä–∞–Ω–∏—Ç–µ **backup** —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ (password manager)

### –†–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤

–ï—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã:

1. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–µ** —Å–µ–∫—Ä–µ—Ç—ã (–ø–∞—Ä–æ–ª–∏, –∫–ª—é—á–∏)
2. **–û–±–Ω–æ–≤–∏—Ç–µ** –Ω–∞ production —Å–µ—Ä–≤–µ—Ä–µ
3. **–û–±–Ω–æ–≤–∏—Ç–µ** –≤ GitHub Secrets
4. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ** –¥–µ–ø–ª–æ–π –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
5. **–£–¥–∞–ª–∏—Ç–µ** —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ –∏–∑ `authorized_keys`

## Troubleshooting

### Deploy –ø–∞–¥–∞–µ—Ç —Å "Permission denied (publickey)"

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `DEPLOY_SSH_KEY` —Å–æ–¥–µ—Ä–∂–∏—Ç **–≤–µ—Å—å** –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (–≤–∫–ª—é—á–∞—è `-----BEGIN/END-----`)
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ `~/.ssh/authorized_keys` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞: `~/.ssh` = 700, `authorized_keys` = 600

### Deploy –ø–∞–¥–∞–µ—Ç —Å ".env.prod –Ω–µ –Ω–∞–π–¥–µ–Ω"

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `ENV_PROD` —Å–µ–∫—Ä–µ—Ç —Å–æ–∑–¥–∞–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç **–ø–æ–ª–Ω—ã–π** `.env.prod`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ workflow –µ—Å—Ç—å —à–∞–≥ —Å–æ–∑–¥–∞–Ω–∏—è `.env.prod`

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è: "invalid port number in database URL"

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ `ENV_PROD`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞—Ä–æ–ª—å **–ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç** `/`, `=`, `@`
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –ë–î –±–µ–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤

## –°—Å—ã–ª–∫–∏

- [GitHub Encrypted Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [GitHub Actions Variables](https://docs.github.com/en/actions/learn-github-actions/variables)
- [SSH Key Authentication](https://www.ssh.com/academy/ssh/key)
- `.env.prod.template` - —à–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `docs/TROUBLESHOOTING.md` - —Ä–µ—à–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
