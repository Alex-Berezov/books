#!/bin/bash

# ะะปะฐะฒะฝัะน ัะบัะธะฟั ะดะปั ะฒัะฟะพะปะฝะตะฝะธั ะัะตัะฐัะธะธ 6: ะะฐัััะพะนะบะฐ ะดะพัััะฟะฐ ะบ ะดะพะผะตะฝั bibliaris.com
# 
# ะญัะพั ัะบัะธะฟั ะบะพะพัะดะธะฝะธััะตั ะฒัะต ััะฐะฟั ะฝะฐัััะพะนะบะธ:
# 1. ะะพะดะณะพัะพะฒะบะฐ ัะฐะนะปะพะฒ ะดะปั ัะตัะฒะตัะฐ
# 2. ะะฝััััะบัะธะธ ะฟะพ DNS
# 3. ะฃััะฐะฝะพะฒะบะฐ ะธ ะฝะฐัััะพะนะบะฐ Caddy ะฝะฐ ัะตัะฒะตัะต
# 4. ะัะพะฒะตัะบะฐ ัะตะทัะปััะฐัะพะฒ

set -euo pipefail

# ะะพะฝัะธะณััะฐัะธั
DOMAIN="bibliaris.com"
SERVER_IP="209.74.88.183"
SERVER_USER="deploy"

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธะธ ะปะพะณะธัะพะฒะฐะฝะธั
log_info() {
    echo -e "${BLUE}[INFO]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*"
}

# ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
check_dependencies() {
    log_info "ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
    
    local missing=()
    
    for cmd in ssh scp dig curl; do
        if ! command -v $cmd &> /dev/null; then
            missing+=($cmd)
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "ะะต ะฝะฐะนะดะตะฝั ะฝะตะพะฑัะพะดะธะผัะต ััะธะปะธัั: ${missing[*]}"
        log_info "ะฃััะฐะฝะพะฒะธัะต ะธั: sudo apt install openssh-client dnsutils curl"
        exit 1
    fi
    
    log_success "ะัะต ะทะฐะฒะธัะธะผะพััะธ ะฝะฐะนะดะตะฝั"
}

# ะัะพะฒะตัะบะฐ SSH ะดะพัััะฟะฐ ะบ ัะตัะฒะตัั
check_ssh_access() {
    log_info "ะัะพะฒะตัะบะฐ SSH ะดะพัััะฟะฐ ะบ ัะตัะฒะตัั $SERVER_IP..."
    
    if ssh -o ConnectTimeout=10 -o BatchMode=yes $SERVER_USER@$SERVER_IP "echo 'SSH OK'" >/dev/null 2>&1; then
        log_success "SSH ะดะพัััะฟ ะบ ัะตัะฒะตัั ัะฐะฑะพัะฐะตั"
    else
        log_error "ะะตั SSH ะดะพัััะฟะฐ ะบ ัะตัะฒะตัั $SERVER_IP"
        log_info "ะฃะฑะตะดะธัะตัั ััะพ:"
        log_info "  - SSH ะบะปัั ะดะพะฑะฐะฒะปะตะฝ ะฝะฐ ัะตัะฒะตั"
        log_info "  - ะะพะปัะทะพะฒะฐัะตะปั $SERVER_USER ัััะตััะฒัะตั"
        log_info "  - ะกะตัะฒะตั ะดะพัััะฟะตะฝ ะฟะพ ัะตัะธ"
        exit 1
    fi
}

# ะะพะฟะธัะพะฒะฐะฝะธะต ัะบัะธะฟัะฐ ะฝะฐ ัะตัะฒะตั
copy_setup_script() {
    log_info "ะะพะฟะธัะพะฒะฐะฝะธะต ัะบัะธะฟัะฐ ัััะฐะฝะพะฒะบะธ ะฝะฐ ัะตัะฒะตั..."
    
    if scp ./setup_bibliaris_caddy.sh $SERVER_USER@$SERVER_IP:/tmp/; then
        log_success "ะกะบัะธะฟั ัะบะพะฟะธัะพะฒะฐะฝ ะฝะฐ ัะตัะฒะตั"
    else
        log_error "ะัะธะฑะบะฐ ะบะพะฟะธัะพะฒะฐะฝะธั ัะบัะธะฟัะฐ ะฝะฐ ัะตัะฒะตั"
        exit 1
    fi
}

# ะะพะบะฐะทะฐัั ะธะฝััััะบัะธะธ ะฟะพ DNS
show_dns_instructions() {
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo -e "${YELLOW}๐ ะะะกะขะะฃะะฆะะ ะะ ะะะกะขะะะะะ DNS${NC}"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    echo -e "${BLUE}๐ ะะพะผะตะฝ:${NC} $DOMAIN"
    echo -e "${BLUE}๐ฅ๏ธ ะกะตัะฒะตั:${NC} $SERVER_IP"
    echo ""
    echo -e "${YELLOW}๐ ะัะฟะพะปะฝะธัะต ัะปะตะดัััะธะต ัะฐะณะธ ะฒ Namecheap:${NC}"
    echo ""
    echo "1. ะะพะนะดะธัะต ะฒ ะฟะฐะฝะตะปั Namecheap"
    echo "2. ะะตัะตะนะดะธัะต ะฒ Domain List โ $DOMAIN โ Manage"
    echo "3. โ๏ธ  ะะะะขะะงะะ: ะฃะดะฐะปะธัะต URL Forward ะฒ ัะฐะทะดะตะปะต 'Redirects'"
    echo "4. ะะตัะตะนะดะธัะต ะฒ 'Advanced DNS'"
    echo "5. ะะพะฑะฐะฒััะต A-record:"
    echo "   Type: A Record"
    echo "   Host: @"
    echo "   Value: $SERVER_IP"
    echo "   TTL: Automatic"
    echo "6. ะกะพััะฐะฝะธัะต ะธะทะผะตะฝะตะฝะธั"
    echo ""
    echo -e "${YELLOW}โฑ๏ธ  DNS ะธะทะผะตะฝะตะฝะธั ะผะพะณัั ะทะฐะฝััั ะดะพ 48 ัะฐัะพะฒ${NC}"
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
}

# ะฃััะฐะฝะพะฒะบะฐ Caddy ะฝะฐ ัะตัะฒะตัะต
install_caddy_on_server() {
    log_info "ะฃััะฐะฝะพะฒะบะฐ ะธ ะฝะฐัััะพะนะบะฐ Caddy ะฝะฐ ัะตัะฒะตัะต..."
    
    echo ""
    log_warning "ะกะตะนัะฐั ะฑัะดะตั ะทะฐะฟััะตะฝะฐ ัััะฐะฝะพะฒะบะฐ Caddy ะฝะฐ ัะตัะฒะตัะต $SERVER_IP"
    log_warning "ะะพััะตะฑััััั ะฟัะฐะฒะฐ sudo ะฝะฐ ัะตัะฒะตัะต"
    echo ""
    
    # ะะฐะฟััะบ ัะบัะธะฟัะฐ ัััะฐะฝะพะฒะบะธ ะฝะฐ ัะตัะฒะตัะต
    if ssh -t $SERVER_USER@$SERVER_IP "sudo bash /tmp/setup_bibliaris_caddy.sh"; then
        log_success "Caddy ััะฟะตัะฝะพ ัััะฐะฝะพะฒะปะตะฝ ะธ ะฝะฐัััะพะตะฝ!"
    else
        log_error "ะัะธะฑะบะฐ ะฟัะธ ัััะฐะฝะพะฒะบะต Caddy"
        return 1
    fi
}

# ะัะพะฒะตัะบะฐ ัะตะบััะตะณะพ ัะพััะพัะฝะธั DNS
check_current_dns() {
    log_info "ะัะพะฒะตัะบะฐ ัะตะบััะตะณะพ ัะพััะพัะฝะธั DNS..."
    
    dns_result=$(dig +short $DOMAIN A 2>/dev/null || echo "")
    
    if [[ "$dns_result" == "$SERVER_IP" ]]; then
        log_success "DNS ัะถะต ะฝะฐัััะพะตะฝ ะฟัะฐะฒะธะปัะฝะพ: $DOMAIN โ $SERVER_IP"
        return 0
    elif [[ -n "$dns_result" ]]; then
        log_warning "DNS ัะบะฐะทัะฒะฐะตั ะฝะฐ ะดััะณะพะน IP: $DOMAIN โ $dns_result"
        log_warning "ะะถะธะดะฐะตััั: $SERVER_IP"
        return 1
    else
        log_warning "DNS ะทะฐะฟะธัะธ ะฝะต ะฝะฐะนะดะตะฝั ะดะปั $DOMAIN"
        return 1
    fi
}

# ะะถะธะดะฐะฝะธะต DNS propagation
wait_for_dns() {
    local max_attempts=20
    local attempt=1
    
    log_info "ะะถะธะดะฐะฝะธะต DNS propagation..."
    
    while [[ $attempt -le $max_attempts ]]; do
        log_info "ะะพะฟััะบะฐ $attempt/$max_attempts..."
        
        if check_current_dns >/dev/null 2>&1; then
            log_success "DNS propagation ะทะฐะฒะตััะตะฝ!"
            return 0
        fi
        
        if [[ $attempt -lt $max_attempts ]]; then
            log_info "DNS ะตัะต ะฝะต ะพะฑะฝะพะฒะปะตะฝ, ะถะดะตะผ 30 ัะตะบัะฝะด..."
            sleep 30
        fi
        
        ((attempt++))
    done
    
    log_warning "DNS propagation ะทะฐะนะผะตั ะฑะพะปััะต ะฒัะตะผะตะฝะธ"
    log_info "ะัะพะฒะตัััะต ะฟะพะทะถะต ะบะพะผะฐะฝะดะพะน: ./scripts/check_bibliaris.sh"
    return 1
}

# ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
final_check() {
    log_info "ะะฐะฟััะบ ัะธะฝะฐะปัะฝะพะน ะฟัะพะฒะตัะบะธ..."
    
    if ./check_bibliaris.sh; then
        log_success "ะัะต ะฟัะพะฒะตัะบะธ ะฟัะพะนะดะตะฝั! ๐"
        echo ""
        echo "โ bibliaris.com ะฟะพะปะฝะพัััั ะฝะฐัััะพะตะฝ ะธ ัะฐะฑะพัะฐะตั"
        echo "๐ API ะดะพัััะฟะตะฝ: https://bibliaris.com/"
    else
        log_warning "ะะตะบะพัะพััะต ะฟัะพะฒะตัะบะธ ะฝะต ะฟัะพัะปะธ"
        log_info "ะะพะทะผะพะถะฝัะต ะฟัะธัะธะฝั:"
        log_info "  - DNS ะตัะต ะฝะต ะพะฑะฝะพะฒะธะปัั ะฟะพะปะฝะพัััั"
        log_info "  - ะัะถะฝะพ ะฒัะตะผั ะฝะฐ ะฟะพะปััะตะฝะธะต SSL ัะตััะธัะธะบะฐัะฐ"
        log_info "ะะพะฒัะพัะธัะต ะฟัะพะฒะตัะบั ัะตัะตะท 10-15 ะผะธะฝัั: ./scripts/check_bibliaris.sh"
    fi
}

# ะัะธััะบะฐ ะฒัะตะผะตะฝะฝัั ัะฐะนะปะพะฒ
cleanup() {
    log_info "ะัะธััะบะฐ ะฒัะตะผะตะฝะฝัั ัะฐะนะปะพะฒ..."
    
    # ะฃะดะฐะปะตะฝะธะต ัะบัะธะฟัะฐ ั ัะตัะฒะตัะฐ
    ssh $SERVER_USER@$SERVER_IP "rm -f /tmp/setup_bibliaris_caddy.sh" 2>/dev/null || true
    
    log_success "ะัะธััะบะฐ ะทะฐะฒะตััะตะฝะฐ"
}

# ะะปะฐะฒะฝะพะต ะผะตะฝั
show_menu() {
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo -e "${BLUE}๐ ะัะตัะฐัะธั 6: ะะฐัััะพะนะบะฐ ะดะพัััะฟะฐ ะบ ะดะพะผะตะฝั bibliaris.com${NC}"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    echo "ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:"
    echo ""
    echo "1) ๐ ะะพะบะฐะทะฐัั ะธะฝััััะบัะธะธ ะฟะพ ะฝะฐัััะพะนะบะต DNS"
    echo "2) ๐ ะฃััะฐะฝะพะฒะธัั Caddy ะฝะฐ ัะตัะฒะตัะต (ััะตะฑัะตั SSH ะดะพัััะฟ)"
    echo "3) ๐ ะัะพะฒะตัะธัั ัะตะบััะตะต ัะพััะพัะฝะธะต DNS"
    echo "4) ๐งช ะัะฟะพะปะฝะธัั ะฟะพะปะฝัั ะฟัะพะฒะตัะบั ะดะพัััะฟะฝะพััะธ"
    echo "5) โก ะัะฟะพะปะฝะธัั ะฒัะต ัะฐะณะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ"
    echo "6) ๐งน ะัะธััะธัั ะฒัะตะผะตะฝะฝัะต ัะฐะนะปั"
    echo "0) ๐ช ะััะพะด"
    echo ""
    read -p "ะะฒะตะดะธัะต ะฝะพะผะตั ะดะตะนััะฒะธั: " choice
    
    case $choice in
        1) show_dns_instructions; show_menu ;;
        2) copy_setup_script && install_caddy_on_server; show_menu ;;
        3) check_current_dns; show_menu ;;
        4) final_check; show_menu ;;
        5) run_full_setup ;;
        6) cleanup; show_menu ;;
        0) log_info "ะััะพะด"; exit 0 ;;
        *) log_error "ะะตะฒะตัะฝัะน ะฒัะฑะพั"; show_menu ;;
    esac
}

# ะะพะปะฝะฐั ะฐะฒัะพะผะฐัะธัะตัะบะฐั ะฝะฐัััะพะนะบะฐ
run_full_setup() {
    log_info "ะะฐะฟััะบ ะฟะพะปะฝะพะน ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะฝะฐัััะพะนะบะธ..."
    echo ""
    
    # ะญัะฐะฟ 1: ะะพะดะณะพัะพะฒะบะฐ
    check_dependencies
    check_ssh_access
    
    # ะญัะฐะฟ 2: ะะฝััััะบัะธะธ ะฟะพ DNS
    show_dns_instructions
    echo ""
    read -p "ะัะฟะพะปะฝะธะปะธ ะฝะฐัััะพะนะบั DNS ะฒ Namecheap? (y/N): " dns_done
    
    if [[ ! "$dns_done" =~ ^[Yy]$ ]]; then
        log_warning "ะกะฝะฐัะฐะปะฐ ะฝะฐัััะพะนัะต DNS, ะทะฐัะตะผ ะทะฐะฟัััะธัะต ัะบัะธะฟั ะทะฐะฝะพะฒะพ"
        exit 1
    fi
    
    # ะญัะฐะฟ 3: ะฃััะฐะฝะพะฒะบะฐ Caddy
    copy_setup_script
    install_caddy_on_server
    
    # ะญัะฐะฟ 4: ะัะพะฒะตัะบะฐ DNS
    if check_current_dns; then
        log_success "DNS ัะถะต ะณะพัะพะฒ!"
    else
        log_info "ะะถะธะดะฐะฝะธะต DNS propagation..."
        wait_for_dns
    fi
    
    # ะญัะฐะฟ 5: ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
    sleep 10  # ะะฐัั ะฒัะตะผั ะฝะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธั SSL
    final_check
    
    # ะญัะฐะฟ 6: ะัะธััะบะฐ
    cleanup
    
    echo ""
    log_success "ะัะตัะฐัะธั 6 ะทะฐะฒะตััะตะฝะฐ! ๐"
}

# ะัะพะฒะตัะบะฐ ะฐัะณัะผะตะฝัะพะฒ ะบะพะผะฐะฝะดะฝะพะน ัััะพะบะธ
if [[ $# -gt 0 ]]; then
    case $1 in
        --auto) run_full_setup ;;
        --dns) show_dns_instructions ;;
        --check) final_check ;;
        --help) 
            echo "ะัะฟะพะปัะทะพะฒะฐะฝะธะต: $0 [OPTION]"
            echo "  --auto    ะะฒัะพะผะฐัะธัะตัะบะพะต ะฒัะฟะพะปะฝะตะฝะธะต ะฒัะตั ััะฐะฟะพะฒ"
            echo "  --dns     ะะพะบะฐะทะฐัั ะธะฝััััะบัะธะธ ะฟะพ DNS"
            echo "  --check   ะัะพะฒะตัะธัั ะดะพัััะฟะฝะพััั ัะฐะนัะฐ"
            echo "  --help    ะะพะบะฐะทะฐัั ััั ัะฟัะฐะฒะบั"
            ;;
        *) log_error "ะะตะธะทะฒะตััะฝัะน ะฟะฐัะฐะผะตัั: $1"; exit 1 ;;
    esac
else
    show_menu
fi
